<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Betting – Cards</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <div class="container header-inner">
      <h1>NHL Betting – Cards</h1>
      <form method="get" action="/">
    <label>Date: <input type="date" name="date" value="{{ date }}" /></label>
    <button type="submit">Apply</button>
  {% if not settled %}
  <button type="button" id="refreshOddsBtn" class="btn" title="Refresh odds and recommendations in the background">Refresh Odds</button>
  {% endif %}
        <a class="btn" href="/recommendations?date={{ date }}">Recommendations</a>
        <a class="btn" href="/props">Props</a>
        
      </form>
      <div id="last-updated" class="last-updated">Last updated: —</div>
  <label class="toggle"><input type="checkbox" id="autoUpdateToggle" /> Auto-update</label>
    </div>
  </header>
  <main>
    <div class="container">
    {% if note %}
      <div class="alert info">{{ note }}</div>
    {% endif %}
    {% if rows|length == 0 %}
      <p>No predictions found for {{ date }} yet. Try Refresh Odds or check back later.</p>
    {% else %}
      <div class="cards">
        {% for r in rows %}
          {% set has_any_odds = r.get('has_any_odds') %}
          {# Compute final result summary for completed games #}
          {% set is_final = (r.get('game_state') and ('FINAL' in r.get('game_state')|upper)) or (settled) %}
          {% set w = 0 %}{% set l = 0 %}{% set psh = 0 %}
          {# Moneyline correctness if available #}
          {% if r.get('winner_correct') is not none %}
            {% if r.get('winner_correct') %}{% set w = w + 1 %}{% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {# Totals pick correctness if available #}
          {% if r.get('totals_pick') and r.get('result_total') %}
            {% if r.get('result_total') == 'Push' %}{% set psh = psh + 1 %}
            {% elif r.get('totals_pick')|lower == r.get('result_total')|lower %}{% set w = w + 1 %}
            {% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {# Puck line pick correctness if available #}
          {% if r.get('ats_pick') and r.get('result_ats') %}
            {% if r.get('ats_pick') == r.get('result_ats') %}{% set w = w + 1 %}{% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {% set result_class = '' %}
          {% if is_final %}
            {% if w > 0 and l == 0 %}{% set result_class = 'final-all-win' %}
            {% elif l > 0 and w == 0 and psh == 0 %}{% set result_class = 'final-all-loss' %}
            {% elif w > 0 and l > 0 %}{% set result_class = 'final-mixed' %}
            {% elif w == 0 and l == 0 and psh > 0 %}{% set result_class = 'final-push' %}
            {% else %}{% set result_class = 'final-neutral' %}{% endif %}
          {% endif %}
          {% set result_badge = ('W' ~ w ~ '-L' ~ l ~ (('-P' ~ psh) if (psh > 0) else '')) if is_final else '' %}
          <div class="card {{ result_class }}" data-game-date="{{ r.date }}" data-gamepk="{{ r.gamePk if r.get('gamePk') else '' }}" data-home-abbr="{{ r.home_abbr }}" data-away-abbr="{{ r.away_abbr }}" data-has-odds="{{ 1 if has_any_odds else 0 }}">
            <div class="row head">
              <div class="game-date js-local-time">{{ r.date }}</div>
              {% if r.venue %}<div class="venue">{{ r.venue }}</div>{% endif %}
              <div class="state">{{ r.game_state if r.game_state else '' }}</div>
              <div class="time-left">—</div>
              {% if is_final %}
              <div class="result-badge">{{ result_badge }}</div>
              {% endif %}
            </div>
            <div class="row matchup">
              <div class="team side">
                <div class="team-line">
                  {% if r.away_logo %}<img alt="" title="{{ r.away }}" src="{{ r.away_logo }}" class="team-logo" />{% endif %}
                  <div class="name">{{ r.away }}</div>
                </div>
                <div class="score-block">
                  <div class="live-score js-live-away" title="Score">{% if settled and r.get('final_away_goals') is not none %}{{ r.get('final_away_goals') }}{% else %}—{% endif %}</div>
                  <div class="sub proj-score" title="Projected goals">{{ '%.2f' % r.proj_away_goals }}</div>
                  <div class="sub ml-line"><span class="ml-label">ML {{ '%.1f' % (100*r.p_away_ml) }}%</span>{% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %} · {{ r.disp_away_ml_odds }}{% if r.disp_away_ml_book is defined and r.disp_away_ml_book %} @ {{ r.disp_away_ml_book }}{% endif %}{% endif %}</div>
                </div>
              </div>
              <div class="vs">vs</div>
              <div class="team side">
                <div class="team-line">
                  {% if r.home_logo %}<img alt="" title="{{ r.home }}" src="{{ r.home_logo }}" class="team-logo" />{% endif %}
                  <div class="name">{{ r.home }}</div>
                </div>
                <div class="score-block">
                  <div class="live-score js-live-home" title="Score">{% if settled and r.get('final_home_goals') is not none %}{{ r.get('final_home_goals') }}{% else %}—{% endif %}</div>
                  <div class="sub proj-score" title="Projected goals">{{ '%.2f' % r.proj_home_goals }}</div>
                  <div class="sub ml-line"><span class="ml-label">ML {{ '%.1f' % (100*r.p_home_ml) }}%</span>{% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %} · {{ r.disp_home_ml_odds }}{% if r.disp_home_ml_book is defined and r.disp_home_ml_book %} @ {{ r.disp_home_ml_book }}{% endif %}{% endif %}</div>
                </div>
              </div>
            </div>
            <div class="row chips">
              <div class="chip title">Moneyline</div>
              {% set ev_a_ml = r.ev_away_ml if 'ev_away_ml' in r else None %}
              {% set ev_h_ml = r.ev_home_ml if 'ev_home_ml' in r else None %}
              <div class="chip {{ 'positive' if (ev_a_ml is not none and ev_a_ml > 0) else ('negative' if (ev_a_ml is not none and ev_a_ml < 0) else 'neutral') }}">
                Away {% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %}{{ r.disp_away_ml_odds }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r.p_away_ml) }}%
                {% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %}
                <span class="book-badge" title="{{ r.disp_away_ml_book if (r.disp_away_ml_book is string) else 'DraftKings' }}">{{ ((r.disp_away_ml_book if (r.disp_away_ml_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_a_ml is not none %}<span class="ev-badge {{ 'pos' if ev_a_ml > 0 else ('neg' if ev_a_ml < 0 else 'neu') }}">EV {{ '%.3f' % ev_a_ml }}</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_h_ml is not none and ev_h_ml > 0) else ('negative' if (ev_h_ml is not none and ev_h_ml < 0) else 'neutral') }}">
                Home {% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %}{{ r.disp_home_ml_odds }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r.p_home_ml) }}%
                {% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %}
                <span class="book-badge" title="{{ r.disp_home_ml_book if (r.disp_home_ml_book is string) else 'DraftKings' }}">{{ ((r.disp_home_ml_book if (r.disp_home_ml_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_h_ml is not none %}<span class="ev-badge {{ 'pos' if ev_h_ml > 0 else ('neg' if ev_h_ml < 0 else 'neu') }}">EV {{ '%.3f' % ev_h_ml }}</span>{% endif %}
              </div>
              {% if (r.get('game_state') and ('FINAL' in r.get('game_state')|upper)) or ((r.get('close_home_ml_odds') or r.get('close_away_ml_odds')) and (settled)) %}
              <div class="chip neutral" title="Closing moneyline">
                Closed: H {{ r.get('close_home_ml_odds') if r.get('close_home_ml_odds') is not none else '—' }} / A {{ r.get('close_away_ml_odds') if r.get('close_away_ml_odds') is not none else '—' }}
              </div>
              {% endif %}
            </div>
            <div class="row chips">
              <div class="chip title">Totals {{ '%.1f' % r.disp_total_line_used if r.disp_total_line_used is defined and r.disp_total_line_used is not none else '' }}</div>
              {% set ev_o = r.ev_over if 'ev_over' in r else None %}
              {% set ev_u = r.ev_under if 'ev_under' in r else None %}
              <div class="chip {{ 'positive' if (ev_o is not none and ev_o > 0) else ('negative' if (ev_o is not none and ev_o < 0) else 'neutral') }}">
                Over {% if r.disp_over_odds is defined and r.disp_over_odds is not none %}{{ r.disp_over_odds }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r.p_over) }}%
                {% if r.disp_over_odds is defined and r.disp_over_odds is not none %}
                <span class="book-badge" title="{{ r.disp_over_book if (r.disp_over_book is string) else 'DraftKings' }}">{{ ((r.disp_over_book if (r.disp_over_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_o is not none %}<span class="ev-badge {{ 'pos' if ev_o > 0 else ('neg' if ev_o < 0 else 'neu') }}">EV {{ '%.3f' % ev_o }}</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_u is not none and ev_u > 0) else ('negative' if (ev_u is not none and ev_u < 0) else 'neutral') }}">
                Under {% if r.disp_under_odds is defined and r.disp_under_odds is not none %}{{ r.disp_under_odds }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r.p_under) }}%
                {% if r.disp_under_odds is defined and r.disp_under_odds is not none %}
                <span class="book-badge" title="{{ r.disp_under_book if (r.disp_under_book is string) else 'DraftKings' }}">{{ ((r.disp_under_book if (r.disp_under_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_u is not none %}<span class="ev-badge {{ 'pos' if ev_u > 0 else ('neg' if ev_u < 0 else 'neu') }}">EV {{ '%.3f' % ev_u }}</span>{% endif %}
              </div>
              {% set pov = (r.get('p_over') or 0) %}
              {% set pun = (r.get('p_under') or 0) %}
              {% set push = 1 - pov - pun %}
              {% if push < 0 %}{% set push = 0 %}{% endif %}
              <div class="chip neutral">Push · {{ '%.1f' % (100*push) }}%</div>
            </div>
            <div class="row chips">
              <div class="chip title">Puck Line</div>
              {% set ev_apl = r['ev_away_pl_+1.5'] if 'ev_away_pl_+1.5' in r else None %}
              {% set ev_hpl = r['ev_home_pl_-1.5'] if 'ev_home_pl_-1.5' in r else None %}
              <div class="chip {{ 'positive' if (ev_apl is not none and ev_apl > 0) else ('negative' if (ev_apl is not none and ev_apl < 0) else 'neutral') }}">
                Away +1.5 {% if r['disp_away_pl_+1.5_odds'] is defined and r['disp_away_pl_+1.5_odds'] is not none %}{{ r['disp_away_pl_+1.5_odds'] }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r['p_away_pl_+1.5']) }}%
                {% if r['disp_away_pl_+1.5_odds'] is defined and r['disp_away_pl_+1.5_odds'] is not none %}
                <span class="book-badge" title="{{ r['disp_away_pl_+1.5_book'] if (r['disp_away_pl_+1.5_book'] is string) else 'DraftKings' }}">{{ ((r['disp_away_pl_+1.5_book'] if (r['disp_away_pl_+1.5_book'] is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_apl is not none %}<span class="ev-badge {{ 'pos' if ev_apl > 0 else ('neg' if ev_apl < 0 else 'neu') }}">EV {{ '%.3f' % ev_apl }}</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_hpl is not none and ev_hpl > 0) else ('negative' if (ev_hpl is not none and ev_hpl < 0) else 'neutral') }}">
                Home -1.5 {% if r['disp_home_pl_-1.5_odds'] is defined and r['disp_home_pl_-1.5_odds'] is not none %}{{ r['disp_home_pl_-1.5_odds'] }}{% else %}—{% endif %}
                · {{ '%.1f' % (100*r['p_home_pl_-1.5']) }}%
                {% if r['disp_home_pl_-1.5_odds'] is defined and r['disp_home_pl_-1.5_odds'] is not none %}
                <span class="book-badge" title="{{ r['disp_home_pl_-1.5_book'] if (r['disp_home_pl_-1.5_book'] is string) else 'DraftKings' }}">{{ ((r['disp_home_pl_-1.5_book'] if (r['disp_home_pl_-1.5_book'] is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_hpl is not none %}<span class="ev-badge {{ 'pos' if ev_hpl > 0 else ('neg' if ev_hpl < 0 else 'neu') }}">EV {{ '%.3f' % ev_hpl }}</span>{% endif %}
              </div>
              {% if not has_any_odds %}
              <div class="chip neutral">No odds available yet</div>
              {% endif %}
            </div>
            <div class="row details">
              <div class="detail-col">
                <div>
                  {% set mt = r.get('model_total') %}
                  {% if mt is not none %}
                    Model Total: <strong>{{ '%.2f' % mt }}</strong>
                  {% endif %}
                  {% if r.get('actual_total') is not none %}
                    · Actual Total: <strong>{{ '%.2f' % r.get('actual_total') }}</strong>
                  {% endif %}
                  {% if r.get('total_diff') is not none %}
                    · Diff: <strong>{{ '%.2f' % r.get('total_diff') }}</strong>
                  {% endif %}
                </div>
                <div>Win Prob: Away {{ '%.1f' % (100*r.p_away_ml) }}% / Home {{ '%.1f' % (100*r.p_home_ml) }}%{% if r.get('winner_actual') %} · Winner: <strong>{{ r.get('winner_actual') }}</strong> <span class="mark {{ 'ok' if r.get('winner_correct') else 'bad' }}">{{ '✓' if r.get('winner_correct') else '✗' }}</span>{% endif %}</div>
              </div>
            </div>
            {% if r.get('totals_pick') or r.get('ats_pick') %}
            <div class="row details">
              <div class="detail-col">
                {% if r.get('totals_pick') %}
                <div>Totals Pick: <strong>{{ r.get('totals_pick') }}</strong>{% if r.get('totals_edge_pts') is not none %} (edge {{ '%.2f' % r.get('totals_edge_pts') }} pts){% endif %}{% if r.get('result_total') %} · Result: <strong>{{ r.get('result_total') }}</strong> {% if r.get('result_total') == 'Push' %}<span class="mark push">–</span>{% else %}<span class="mark {{ 'ok' if r.get('totals_pick_correct') else 'bad' }}">{{ '✓' if r.get('totals_pick_correct') else '✗' }}</span>{% endif %}{% endif %}</div>
                {% endif %}
                {% if r.get('ats_pick') %}
                <div>ATS Pick: <strong>{{ 'Home -1.5' if r.get('ats_pick') == 'home_-1.5' else 'Away +1.5' }}</strong>{% if r.get('ats_edge_pts') is not none %} (edge {{ '%.2f' % r.get('ats_edge_pts') }} pts){% endif %}{% if r.get('result_ats') %} · Result: <strong>{{ 'Home -1.5' if r.get('result_ats') == 'home_-1.5' else 'Away +1.5' }}</strong> <span class="mark {{ 'ok' if r.get('ats_pick_correct') else 'bad' }}">{{ '✓' if r.get('ats_pick_correct') else '✗' }}</span>{% endif %}</div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% if r.disp_over_odds is defined or r.disp_home_ml_odds is defined %}
            <div class="row details small">
              <div class="detail-col">
                <div>
                  Lines: ML {% if r.disp_home_ml_odds is not none and r.disp_away_ml_odds is not none %}H {{ r.disp_home_ml_odds }} / A {{ r.disp_away_ml_odds }}{% else %}—{% endif %}
                  · Total {% if r.disp_total_line_used is defined and r.disp_total_line_used is not none %}{{ '%.1f' % r.disp_total_line_used }}{% else %}—{% endif %}
                  · PL ±1.5
                </div>
              </div>
            </div>
            {% endif %}
            {% if r.get('rec_market') %}
            <div class="row details">
              <div class="detail-col">
                <div class="rec-pill {{ 'ok' if r.get('rec_success') else ('push' if r.get('rec_result') == 'Push' else ('')) }}">
                  Recommendation: <strong>{{ r.get('rec_label') }}</strong>
                  {% if r.get('rec_confidence') %} <span class="rec-conf {{ r.get('rec_confidence')|lower }}">{{ r.get('rec_confidence') }}</span>{% endif %}
                  · EV {{ '%.3f' % r.get('rec_ev') if r.get('rec_ev') is not none else '—' }}
                  {% if r.get('rec_odds') is not none %} · {{ r.get('rec_odds') }}{% endif %}
                  {% if r.get('rec_book') %} @ {{ r.get('rec_book') }}{% endif %}
                  {% if r.get('rec_result') %} · Result: <strong>{{ r.get('rec_result') }}</strong>{% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            {% if r.get('model_pick') and r.get('model_pick_prob') is not none %}
            <div class="row details small">
              <div class="detail-col">
                <div class="model-pill">Model Pick: <strong>{{ r.get('model_pick') }}</strong> · {{ '%.1f' % (100*r.get('model_pick_prob')) }}%</div>
              </div>
            </div>
            {% endif %}
            <div class="row details small">
              <div class="detail-col">
                <div>Debug: {{ date }} | {{ r.home_abbr }}-{{ r.away_abbr }} | gamePk={{ r.gamePk if r.get('gamePk') else '—' }} | hasOdds={{ 1 if has_any_odds else 0 }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    </div>
  </main>
</body>
<script>
(function() {
  const qsDate = new URLSearchParams(window.location.search).get('date');
  const date = qsDate || '{{ date }}';
  const liveNow = '{{ 1 if live_now else 0 }}' === '1';
  const isSettled = '{{ 1 if settled else 0 }}' === '1';
  const lastEl = document.getElementById('last-updated');
  let lastVal = null;
  const pollIntervalMs = 60000; // 60s last-updated polling
  const liveIntervalMs = 15000; // 15s live scoreboard polling
  const refreshOddsMs = 600000; // 10m background odds refresh during window
  const toggleEl = document.getElementById('autoUpdateToggle');
  // injectOdds button removed
  const refetchBtn = document.getElementById('refreshOddsBtn');

  // Format all game dates into the user's local timezone
  (function formatLocalTimes(){
    const nodes = Array.from(document.querySelectorAll('.card[data-game-date] .js-local-time'));
    const fmt = new Intl.DateTimeFormat(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    nodes.forEach(node => {
      const card = node.closest('.card');
      const iso = card ? card.getAttribute('data-game-date') : null;
      if (!iso) return;
      const d = new Date(iso);
      if (isNaN(d)) {
        node.textContent = iso;
        return;
      }
      node.textContent = fmt.format(d);
    });
  })();

  // If settled, disable toggle and fully skip any background polling/network calls
  if (isSettled) {
    if (toggleEl) { try { toggleEl.disabled = true; toggleEl.checked = false; } catch(_){} }
    // Still show last-updated once (already rendered server-side note). No timers.
    return;
  }

  async function updateLastUpdated() {
    try {
      const res = await fetch(`/api/last-updated?date=${encodeURIComponent(date)}`, { cache: 'no-store' });
      if (res.ok) {
        const data = await res.json();
        const val = data.last_modified || null;
        if (lastEl) {
          lastEl.textContent = 'Last updated: ' + (val ? new Date(val).toLocaleString() : '—');
        }
        return val;
      }
    } catch (e) {}
    return null;
  }
  function anyOddsMissing() {
    const cards = Array.from(document.querySelectorAll('.card[data-has-odds]'));
    if (!cards.length) return true;
    return cards.some(el => el.getAttribute('data-has-odds') !== '1');
  }
  function anyHasOdds() {
    const cards = Array.from(document.querySelectorAll('.card[data-has-odds]'));
    if (!cards.length) return false;
    return cards.some(el => el.getAttribute('data-has-odds') === '1');
  }


  function computeGameWindow() {
    const times = Array.from(document.querySelectorAll('.card[data-game-date]'))
      .map(el => new Date(el.getAttribute('data-game-date')))
      .filter(d => !isNaN(d));
    if (!times.length) return null;
    const earliest = new Date(Math.min.apply(null, times));
    const latest = new Date(Math.max.apply(null, times));
    // Define a polling window: 90 min before first game to 4 hours after last start
    const start = new Date(earliest.getTime() - 90*60*1000);
    const end = new Date(latest.getTime() + 4*60*60*1000);
    return { start, end };
  }

  async function maybeReloadOnChange() {
    const val = await updateLastUpdated();
    if (lastVal && val && val !== lastVal) {
      // Data file changed; reload to update cards
      window.location.reload();
      return;
    }
    if (val) lastVal = val;
  }

  async function refreshOdds() {
    if (isSettled) return; // never refresh odds for settled slates
    try {
      const url = liveNow ? `/api/refresh-odds?date=${encodeURIComponent(date)}&backfill=1` : `/api/refresh-odds?date=${encodeURIComponent(date)}`;
      await fetch(url, { method: 'GET', cache: 'no-store' });
    } catch (e) {}
  }

  // Initialize
  updateLastUpdated().then(async (v) => {
    lastVal = v;
    // If any card is missing odds, try a one-shot background refresh (skips during live)
    if (!isSettled && !liveNow && anyOddsMissing()) {
      await refreshOdds();
      // Re-check last-updated to trigger reload if changed
      setTimeout(async () => {
        const nv = await updateLastUpdated();
        if (nv && lastVal && nv !== lastVal) {
          window.location.reload();
        }
      }, 3000);
    }
    // If not live and we already have odds, snapshot openers once (idempotent server-side)
    try {
      if (!isSettled && !liveNow && anyHasOdds()) {
        await fetch(`/api/capture-openers?date=${encodeURIComponent(date)}`, { method: 'POST' });
      }
    } catch (_) {}
  });

  // manual inject removed

  // Manual refetch handler (current day)
  if (refetchBtn) {
    refetchBtn.addEventListener('click', async () => {
      try {
        refetchBtn.disabled = true;
        const label = refetchBtn.textContent;
        refetchBtn.textContent = 'Refetching…';
        const before = await updateLastUpdated();
  const url = liveNow ? `/api/refresh-odds?date=${encodeURIComponent(date)}&backfill=1` : `/api/refresh-odds?date=${encodeURIComponent(date)}`;
  await fetch(url, { method: 'GET', cache: 'no-store' });
        setTimeout(async () => {
          const after = await updateLastUpdated();
          refetchBtn.disabled = false;
          refetchBtn.textContent = label;
          if (before && after && before !== after) {
            window.location.reload();
          }
        }, 2500);
      } catch (_) {
        try { refetchBtn.disabled = false; } catch {}
      }
    });
  }

  const windowRange = computeGameWindow();
  let pollTimer = null;
  let oddsTimer = null;
  let liveTimer = null;
  function inWindow() {
    if (!windowRange) return false;
    const now = new Date();
    return now >= windowRange.start && now <= windowRange.end;
  }
  function startLoops() {
    if (isSettled) return; // disable auto loops on settled slates
    if (!pollTimer) pollTimer = setInterval(maybeReloadOnChange, pollIntervalMs);
    if (!oddsTimer) oddsTimer = setInterval(refreshOdds, refreshOddsMs);
    // Start live polling regardless of game window to ensure scores appear
    if (!liveTimer) liveTimer = setInterval(refreshLive, liveIntervalMs);
  }
  function stopLoops() {
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    if (oddsTimer) { clearInterval(oddsTimer); oddsTimer = null; }
    if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
  }

  // Engage loops only during game-time window
  function shouldAutoUpdate() {
    // Now opt-in: only auto update (poll + live scoreboard + odds refresh interval) if explicitly set to 'on'
    try { return localStorage.getItem('autoUpdate') === 'on'; } catch { return false; }
  }
  function applyToggleState() {
    if (!toggleEl) return;
    toggleEl.checked = shouldAutoUpdate();
  }
  applyToggleState(); // Will be unchecked unless user previously set 'on'
  // Disable the toggle visually for settled slates
  if (isSettled && toggleEl) {
    toggleEl.disabled = true;
    toggleEl.checked = false;
  }
  if (toggleEl) {
    toggleEl.addEventListener('change', () => {
      try { localStorage.setItem('autoUpdate', toggleEl.checked ? 'on' : 'off'); } catch {}
      if (toggleEl.checked && inWindow()) startLoops(); else stopLoops();
    });
  }
  if (shouldAutoUpdate()) {
    startLoops();
  }
  // Re-check every 5 minutes to honor toggle and adjust other loops if desired
  setInterval(() => {
    if (shouldAutoUpdate()) startLoops(); else stopLoops();
  }, 5*60*1000);

  window.addEventListener('beforeunload', stopLoops);

  async function refreshLive() {
    try {
      const res = await fetch(`/api/scoreboard?date=${encodeURIComponent(date)}`, { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();
      // Index by gamePk and by abbr pair
      const byPk = new Map();
      const byAbbr = new Map();
      for (const g of data) {
        if (g.gamePk) byPk.set(String(g.gamePk), g);
        const key = (g.home_abbr || '') + '|' + (g.away_abbr || '');
        byAbbr.set(key, g);
      }
      const cards = document.querySelectorAll('.card');
      cards.forEach(async (card) => {
        const pk = card.getAttribute('data-gamepk');
        const h = (card.getAttribute('data-home-abbr') || '').toUpperCase();
        const a = (card.getAttribute('data-away-abbr') || '').toUpperCase();
        let g = null;
        if (pk && byPk.has(pk)) g = byPk.get(pk);
        if (!g) {
          const key = h + '|' + a;
          if (byAbbr.has(key)) g = byAbbr.get(key);
        }
        if (!g) return;
        // Update state text and time-left
        const stateEl = card.querySelector('.row.head .state');
        const timeEl = card.querySelector('.row.head .time-left');
        if (stateEl) {
          const seg = [];
          if (g.gameState) seg.push(g.gameState);
          if (g.clock) seg.push(String(g.clock));
          if (g.period) seg.push('P' + g.period);
          stateEl.textContent = seg.join(' · ');
          const st = (g.gameState || '').toUpperCase();
          stateEl.classList.toggle('crit', st.includes('CRIT'));
        }
        if (timeEl) {
          let t = '';
          const st = (g.gameState || '').toUpperCase();
          if (st.includes('FINAL')) {
            t = 'Final';
          } else if (g.period || g.clock) {
            const pd = g.period ? ('P' + g.period) : '';
            const cl = g.clock ? String(g.clock) : '';
            t = [pd, cl].filter(Boolean).join(' ');
          } else if (st.includes('LIVE') || st.includes('IN') || st.includes('PROGRESS') || st.includes('CRIT')) {
            t = 'Live';
          } else {
            t = '';
          }
          timeEl.textContent = t || '—';
          timeEl.classList.toggle('crit', st.includes('CRIT'));
        }
        // Update live scores (do not overwrite projections)
        const ha = card.querySelector('.js-live-home');
        const aa = card.querySelector('.js-live-away');
        if (ha && g.home_goals != null) ha.textContent = String(g.home_goals);
        if (aa && g.away_goals != null) aa.textContent = String(g.away_goals);

        // If the game is LIVE or FINAL and we haven't captured closing odds yet, do it once
        try {
          const already = card.getAttribute('data-close-captured') === '1';
          const st = (g.gameState || '').toUpperCase();
          const isLive = st.includes('LIVE') || st.includes('IN') || st.includes('PROGRESS') || st.includes('FINAL');
          if (!already && isLive && h && a) {
            const url = `/api/capture-closing?date=${encodeURIComponent(date)}&home_abbr=${encodeURIComponent(h)}&away_abbr=${encodeURIComponent(a)}`;
            await fetch(url, { method: 'POST' });
            card.setAttribute('data-close-captured', '1');
          }
        } catch (_) { /* ignore capture errors */ }
      });
    } catch (e) { /* ignore */ }
  }
  // Do an initial live refresh immediately so scores appear without waiting for the first interval
  if (!isSettled) {
    refreshLive();
  }
})();
</script>
</html>
