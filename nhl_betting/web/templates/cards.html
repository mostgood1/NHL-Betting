<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL Betting â€“ Cards</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
  .indicator-splits { margin-top:6px; font-size:11px; line-height:1.4; }
    .row.head .period-pill { font-weight:600; padding:2px 6px; border-radius:12px; background:#222; color:#fff; font-size:0.75rem; letter-spacing:0.5px; }
    .row.head .time-left { font-size:0.75rem; color:#555; min-width:34px; text-align:center; }
    .row.head .period-pill.crit, .row.head .time-left.crit { background:#8b0000; color:#fff; }
  /* Removed scoreboard timestamp banner (.sb-last) per user request */
    .row.head .period-pill.int { background:#444; color:#ffecb3; }
    .hb-wrap { display:flex; align-items:center; gap:8px; font-size:0.70rem; color:#666; }
    .hb-dot { width:10px; height:10px; border-radius:50%; background:#444; position:relative; overflow:hidden; }
    .hb-dot.pulse { animation: hb-pulse 0.9s ease-out 1; background:#19c37d; }
    @keyframes hb-pulse { 0% { box-shadow:0 0 0 0 rgba(25,195,125,0.8); transform:scale(0.6);} 60% { box-shadow:0 0 0 6px rgba(25,195,125,0); } 100% { box-shadow:0 0 0 0 rgba(25,195,125,0); transform:scale(1);} }
  .last-sb { font-variant-numeric:tabular-nums; }
  .pause-btn { margin-left:4px; }
  .debug-date { font-size:0.65rem; color:#c33; margin-left:6px; }
  /* Period projections - Traditional line score table */
  .period-projections { margin: 12px 0; border: 1px solid var(--border, #243356); border-radius: 8px; background: var(--card-bg, #0f1530); overflow: hidden; }
  .period-projections summary { cursor: pointer; padding: 10px 14px; font-weight: 600; font-size: 13px; color: var(--text, #cfe0ff); -webkit-user-select: none; user-select: none; border-bottom: 1px solid var(--border, #243356); background: rgba(255,255,255,0.02); }
  .period-projections summary::-webkit-details-marker { display: none; }
  .period-projections[open] summary { background: rgba(255,255,255,0.04); }
  .line-score { width: 100%; border-collapse: collapse; font-size: 13px; font-variant-numeric: tabular-nums; }
  .line-score thead th { text-align: center; padding: 8px 6px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted, #9fb0ff); background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border, #243356); }
  .line-score thead th:first-child { text-align: left; padding-left: 14px; }
  .line-score tbody td { text-align: center; padding: 10px 6px; color: var(--text, #cfe0ff); border-bottom: 1px solid rgba(36, 51, 86, 0.3); }
  .line-score tbody tr:last-child td { border-bottom: none; }
  .line-score tbody td.team-name { text-align: left; padding-left: 14px; font-weight: 600; }
  .line-score tbody td.total-val { font-weight: 700; background: rgba(255,255,255,0.03); border-left: 1px solid var(--border, #243356); }
  .line-score tbody .period-val { color: var(--text-muted, #9fb0ff); }
  .line-score tbody .home-row { background: rgba(255,255,255,0.01); }
  /* Light mode overrides */
  body.light .period-projections { border-color: #cbd5e1; background: #ffffff; }
  body.light .period-projections summary { color: #0a0f1c; border-bottom-color: #cbd5e1; background: #f8fafc; }
  body.light .period-projections[open] summary { background: #f1f5f9; }
  body.light .line-score thead th { color: #475569; background: #f8fafc; border-bottom-color: #cbd5e1; }
  body.light .line-score tbody td { color: #0a0f1c; border-bottom-color: #e2e8f0; }
  body.light .line-score tbody td.total-val { background: #f1f5f9; border-left-color: #cbd5e1; }
  body.light .line-score tbody .period-val { color: #64748b; }
  body.light .line-score tbody .home-row { background: #f8fafc; }
  /* First 10 minutes indicator */
  .first-10min-indicator { margin: 16px 0; padding: 14px; background: rgba(255,255,255,0.02); border: 1px solid var(--border, #243356); border-radius: 8px; }
  .indicator-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted, #9fb0ff); font-weight: 600; margin-bottom: 8px; }
  .indicator-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
  .indicator-value.high { color: #2e8b57; }
  .indicator-value.medium { color: #f59e0b; }
  .indicator-value.low { color: #64748b; }
  .indicator-subtitle { font-size: 12px; color: var(--text-muted, #9fb0ff); }
  .hot-start { display: inline-block; margin-left: 8px; font-size: 14px; padding: 4px 8px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border-radius: 4px; font-weight: 600; color: #fff; }
  /* Light mode overrides for first 10 min indicator */
  body.light .first-10min-indicator { background: #f8fafc; border-color: #cbd5e1; }
  body.light .indicator-label { color: #475569; }
  body.light .indicator-value.low { color: #94a3b8; }
  body.light .indicator-subtitle { color: #64748b; }
  </style>
  <script>
  // Theme toggle initialization (before page render)
  (function() {
    try {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.documentElement.classList.add('light');
      }
    } catch (e) {}
  })();
  </script>
</head>
<body>
  <header>
    <div class="container header-inner">
      <h1>NHL Betting â€“ Cards</h1>
      <form method="get" action="/">
    <label>Date: <input type="date" name="date" value="{{ date }}" /></label>
    <button type="submit">Apply</button>
    {% if original_date and original_date != date %}
      <span class="debug-date">(Requested: {{ original_date }} â†’ Showing: {{ date }})</span>
    {% endif %}
  {% if not settled %}
  <button type="button" id="refreshOddsBtn" class="btn" title="Refresh odds and recommendations in the background">Refresh Odds</button>
  {% endif %}
  <a class="btn" href="/recommendations?date={{ date }}">Recommendations</a>
  <a class="btn" href="/props">Props</a>
  <a class="btn" href="/props/recommendations?date={{ date }}">Props Recs</a>
  <a class="btn" href="/props/reconciliation?date={{ date }}">Props Recon</a>
  <a class="btn" href="/props/stats-calibration">Props Cal</a>
  <button type="button" id="themeToggle" class="btn" title="Toggle light/dark theme">Toggle Theme</button>
        
      </form>
      <div class="hb-wrap">
        <div class="hb-dot" id="hbDot" title="Live polling active"></div>
        <div id="last-sb" class="last-sb" title="Last scoreboard poll (client clock)">â€”</div>
  <!-- Data (predictions file) timestamp hidden per user request; still updated internally if element restored -->
  <button type="button" id="pauseBtn" class="btn btn-compact pause-btn">Pause</button>
      </div>
  <!-- Auto-update checkbox removed: replaced with Pause/Resume button -->
    </div>
  </header>
  <main>
    <div class="container">
    {% if note %}
      <div class="alert info">{{ note }}</div>
    {% endif %}
    {% if rows|length == 0 %}
      <p>No predictions found for {{ date }} yet. Try Refresh Odds or check back later.</p>
    {% else %}
      <div class="cards">
        {% for r in rows %}
          {% set has_any_odds = r.get('has_any_odds') %}
          {# Compute final result summary for completed games #}
          {% set is_final = (r.get('game_state') and ('FINAL' in r.get('game_state')|upper)) or (settled) %}
          {% set w = 0 %}{% set l = 0 %}{% set psh = 0 %}
          {# Moneyline correctness if available #}
          {% if r.get('winner_correct') is not none %}
            {% if r.get('winner_correct') %}{% set w = w + 1 %}{% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {# Totals pick correctness if available #}
          {% if r.get('totals_pick') and r.get('result_total') %}
            {% if r.get('result_total') == 'Push' %}{% set psh = psh + 1 %}
            {% elif r.get('totals_pick')|lower == r.get('result_total')|lower %}{% set w = w + 1 %}
            {% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {# Puck line pick correctness if available #}
          {% if r.get('ats_pick') and r.get('result_ats') %}
            {% if r.get('ats_pick') == r.get('result_ats') %}{% set w = w + 1 %}{% else %}{% set l = l + 1 %}{% endif %}
          {% endif %}
          {% set result_class = '' %}
          {% if is_final %}
            {% if w > 0 and l == 0 %}{% set result_class = 'final-all-win' %}
            {% elif l > 0 and w == 0 and psh == 0 %}{% set result_class = 'final-all-loss' %}
            {% elif w > 0 and l > 0 %}{% set result_class = 'final-mixed' %}
            {% elif w == 0 and l == 0 and psh > 0 %}{% set result_class = 'final-push' %}
            {% else %}{% set result_class = 'final-neutral' %}{% endif %}
          {% endif %}
          {% set result_badge = ('W' ~ w ~ '-L' ~ l ~ (('-P' ~ psh) if (psh > 0) else '')) if is_final else '' %}
          {% set game_state_upper = (r.get('game_state') or '')|upper %}
          {% set is_final_state = ('FINAL' in game_state_upper) %}
          <div class="card {{ result_class }}" data-game-date="{{ r.date }}" data-gamepk="{{ r.gamePk if r.get('gamePk') else '' }}" data-home-abbr="{{ r.home_abbr }}" data-away-abbr="{{ r.away_abbr }}" data-has-odds="{{ 1 if has_any_odds else 0 }}">
            <div class="row head">
              <div class="game-date js-local-time">{{ r.date }}</div>
              {% if r.venue %}<div class="venue">{{ r.venue }}</div>{% endif %}
              <div class="state">{{ r.game_state if r.game_state else '' }}</div>
              <div class="period-pill" title="Current period">{% if r.game_state and ('FINAL' in r.game_state|upper) %}Final{% else %}{% if r.get('game_state') and ('LIVE' in r.game_state|upper or 'PROGRESS' in r.game_state|upper) and r.get('period') %}P{{ r.get('period') }}{% endif %}{% endif %}</div>
              <div class="time-left" title="Time left in period">â€”</div>
              {% if is_final %}
              <div class="result-badge">{{ result_badge }}</div>
              {% endif %}
            </div>
            <div class="row matchup">
              <div class="team side">
                <div class="team-line">
                  {% if r.away_logo %}<img alt="" title="{{ r.away }}" src="{{ r.away_logo }}" class="team-logo" />{% endif %}
                  <div class="name">{{ r.away }}</div>
                </div>
                <div class="score-block">
                  <div class="live-score js-live-away" title="Score">{% if settled and r.get('final_away_goals') is not none %}{{ r.get('final_away_goals') }}{% else %}â€”{% endif %}</div>
                  {% set pag = r.get('proj_away_goals') %}
                  <div class="sub proj-score" title="Projected goals">{{ ('%.2f' % pag) if (pag is not none) else 'â€”' }}</div>
                  <div class="sub ml-line"><span class="ml-label">ML {{ '%.1f' % (100*r.p_away_ml) }}%</span>{% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %} Â· {{ r.disp_away_ml_odds }}{% if r.disp_away_ml_book is defined and r.disp_away_ml_book %} @ {{ r.disp_away_ml_book }}{% endif %}{% endif %}</div>
                </div>
              </div>
              <div class="vs">vs</div>
              <div class="team side">
                <div class="team-line">
                  {% if r.home_logo %}<img alt="" title="{{ r.home }}" src="{{ r.home_logo }}" class="team-logo" />{% endif %}
                  <div class="name">{{ r.home }}</div>
                </div>
                <div class="score-block">
                  <div class="live-score js-live-home" title="Score">{% if settled and r.get('final_home_goals') is not none %}{{ r.get('final_home_goals') }}{% else %}â€”{% endif %}</div>
                  {% set phg = r.get('proj_home_goals') %}
                  <div class="sub proj-score" title="Projected goals">{{ ('%.2f' % phg) if (phg is not none) else 'â€”' }}</div>
                  <div class="sub ml-line"><span class="ml-label">ML {{ '%.1f' % (100*r.p_home_ml) }}%</span>{% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %} Â· {{ r.disp_home_ml_odds }}{% if r.disp_home_ml_book is defined and r.disp_home_ml_book %} @ {{ r.disp_home_ml_book }}{% endif %}{% endif %}</div>
                </div>
              </div>
            </div>
            {# Period-by-period projections - Traditional line score format #}
            {% set has_period_data = r.get('period1_home_proj') is not none and r.get('period1_away_proj') is not none %}
            {% if has_period_data %}
            <details class="period-projections" open>
              <summary>Projected Line Score â–¾</summary>
              <table class="line-score">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>1st</th>
                    <th>2nd</th>
                    <th>3rd</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="away-row">
                    <td class="team-name">{{ r.get('away', '') }}</td>
                    <td class="period-val">{{ '%.2f' % r.period1_away_proj if r.get('period1_away_proj') is not none else 'â€”' }}</td>
                    <td class="period-val">{{ '%.2f' % r.period2_away_proj if r.get('period2_away_proj') is not none else 'â€”' }}</td>
                    <td class="period-val">{{ '%.2f' % r.period3_away_proj if r.get('period3_away_proj') is not none else 'â€”' }}</td>
                    <td class="total-val">{{ '%.2f' % r.proj_away_goals if r.get('proj_away_goals') is not none else 'â€”' }}</td>
                  </tr>
                  <tr class="home-row">
                    <td class="team-name">{{ r.get('home', '') }}</td>
                    <td class="period-val">{{ '%.2f' % r.period1_home_proj if r.get('period1_home_proj') is not none else 'â€”' }}</td>
                    <td class="period-val">{{ '%.2f' % r.period2_home_proj if r.get('period2_home_proj') is not none else 'â€”' }}</td>
                    <td class="period-val">{{ '%.2f' % r.period3_home_proj if r.get('period3_home_proj') is not none else 'â€”' }}</td>
                    <td class="total-val">{{ '%.2f' % r.proj_home_goals if r.get('proj_home_goals') is not none else 'â€”' }}</td>
                  </tr>
                </tbody>
              </table>
            </details>
            
            {# First 10 Minutes Goal Probability #}
            {% set first_10_proj = r.get('first_10min_proj') %}
            {# Prefer unified p_f10_yes when present; fallback to explicit prob or lambda #}
            {% set _prob_val = r.get('p_f10_yes') if r.get('p_f10_yes') is not none else r.get('first_10min_prob') %}
            {% if _prob_val is none and first_10_proj is not none %}
              {% set _prob_val = 1 - (2.71828 ** (-first_10_proj)) %}
            {% endif %}
            {% if _prob_val is not none and _prob_val > 0 %}
            <div class="first-10min-indicator">
              {% set prob_at_least_one = _prob_val * 100 %}
              <div class="indicator-label">First 10 Min Goal Probability</div>
              <div class="indicator-value {% if prob_at_least_one >= 70 %}high{% elif prob_at_least_one >= 55 %}medium{% else %}low{% endif %}">
                {{ '%.0f' % prob_at_least_one }}%
                {% if prob_at_least_one >= 70 %}
                <span class="hot-start">ðŸ”¥ HOT START EXPECTED</span>
                {% endif %}
              </div>
              <div class="indicator-subtitle">Expected goals (0-10m): {{ '%.2f' % first_10_proj }}</div>
              {% set _hs = r.get('p_f10_home_scores') %}
              {% set _ha = r.get('p_f10_home_allows') %}
              {% set _as = r.get('p_f10_away_scores') %}
              {% set _aa = r.get('p_f10_away_allows') %}
              {% if _hs is not none and _ha is not none and _as is not none and _aa is not none %}
              <div class="indicator-subtitle indicator-splits">
                Home score {{ '%.0f' % (100*_hs) }}% Â· Home allow {{ '%.0f' % (100*_ha) }}%<br/>
                Away score {{ '%.0f' % (100*_as) }}% Â· Away allow {{ '%.0f' % (100*_aa) }}%<br/>
                Blend yes {{ '%.0f' % (100*(r.get('p_f10_yes') or _prob_val)) }}%
              </div>
              {% endif %}
            </div>
            {% endif %}
            {% endif %}
            <div class="row chips">
              <div class="chip title">Moneyline</div>
              {% set ev_a_ml = r.ev_away_ml if 'ev_away_ml' in r else None %}
              {% set ev_h_ml = r.ev_home_ml if 'ev_home_ml' in r else None %}
              {% set is_model_away = (r.get('model_pick') == 'Away ML') %}
              {% set is_model_home = (r.get('model_pick') == 'Home ML') %}
              <div class="chip {{ 'positive' if (ev_a_ml is not none and ev_a_ml > 0) else ('negative' if (ev_a_ml is not none and ev_a_ml < 0) else 'neutral') }} {{ 'model-pick' if is_model_away else '' }}">
                Away {% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %}{{ r.disp_away_ml_odds }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r.p_away_ml) }}%
                {% if r.disp_away_ml_odds is defined and r.disp_away_ml_odds is not none %}
                <span class="book-badge" title="{{ r.disp_away_ml_book if (r.disp_away_ml_book is string) else 'DraftKings' }}">{{ ((r.disp_away_ml_book if (r.disp_away_ml_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_a_ml is not none %}<span class="ev-badge {{ 'pos' if ev_a_ml > 0 else ('neg' if ev_a_ml < 0 else 'neu') }}">EV {{ ('+' if ev_a_ml > 0 else '') ~ ('%.1f' % (100*ev_a_ml)) }}%</span>{% endif %}
                {% if is_model_away %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_h_ml is not none and ev_h_ml > 0) else ('negative' if (ev_h_ml is not none and ev_h_ml < 0) else 'neutral') }} {{ 'model-pick' if is_model_home else '' }}">
                Home {% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %}{{ r.disp_home_ml_odds }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r.p_home_ml) }}%
                {% if r.disp_home_ml_odds is defined and r.disp_home_ml_odds is not none %}
                <span class="book-badge" title="{{ r.disp_home_ml_book if (r.disp_home_ml_book is string) else 'DraftKings' }}">{{ ((r.disp_home_ml_book if (r.disp_home_ml_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_h_ml is not none %}<span class="ev-badge {{ 'pos' if ev_h_ml > 0 else ('neg' if ev_h_ml < 0 else 'neu') }}">EV {{ ('+' if ev_h_ml > 0 else '') ~ ('%.1f' % (100*ev_h_ml)) }}%</span>{% endif %}
                {% if is_model_home %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              {% if (r.get('game_state') and ('FINAL' in r.get('game_state')|upper)) or ((r.get('close_home_ml_odds') or r.get('close_away_ml_odds')) and (settled)) %}
              <div class="chip neutral" title="Closing moneyline">
                Closed: H {{ r.get('close_home_ml_odds') if r.get('close_home_ml_odds') is not none else 'â€”' }} / A {{ r.get('close_away_ml_odds') if r.get('close_away_ml_odds') is not none else 'â€”' }}
              </div>
              {% endif %}
            </div>
            <div class="row chips">
              <div class="chip title">Totals {{ '%.1f' % r.disp_total_line_used if r.disp_total_line_used is defined and r.disp_total_line_used is not none else '' }}</div>
              {% set ev_o = r.ev_over if 'ev_over' in r else None %}
              {% set ev_u = r.ev_under if 'ev_under' in r else None %}
              {% set is_model_over = (r.get('model_pick_total') == 'Over') %}
              {% set is_model_under = (r.get('model_pick_total') == 'Under') %}
              <div class="chip {{ 'positive' if (ev_o is not none and ev_o > 0) else ('negative' if (ev_o is not none and ev_o < 0) else 'neutral') }} {{ 'model-pick' if is_model_over else '' }}">
                Over {% if r.disp_over_odds is defined and r.disp_over_odds is not none %}{{ r.disp_over_odds }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r.p_over) }}%
                {% if r.disp_over_odds is defined and r.disp_over_odds is not none %}
                <span class="book-badge" title="{{ r.disp_over_book if (r.disp_over_book is string) else 'DraftKings' }}">{{ ((r.disp_over_book if (r.disp_over_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_o is not none %}<span class="ev-badge {{ 'pos' if ev_o > 0 else ('neg' if ev_o < 0 else 'neu') }}">EV {{ ('+' if ev_o > 0 else '') ~ ('%.1f' % (100*ev_o)) }}%</span>{% endif %}
                {% if is_model_over %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_u is not none and ev_u > 0) else ('negative' if (ev_u is not none and ev_u < 0) else 'neutral') }} {{ 'model-pick' if is_model_under else '' }}">
                Under {% if r.disp_under_odds is defined and r.disp_under_odds is not none %}{{ r.disp_under_odds }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r.p_under) }}%
                {% if r.disp_under_odds is defined and r.disp_under_odds is not none %}
                <span class="book-badge" title="{{ r.disp_under_book if (r.disp_under_book is string) else 'DraftKings' }}">{{ ((r.disp_under_book if (r.disp_under_book is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_u is not none %}<span class="ev-badge {{ 'pos' if ev_u > 0 else ('neg' if ev_u < 0 else 'neu') }}">EV {{ ('+' if ev_u > 0 else '') ~ ('%.1f' % (100*ev_u)) }}%</span>{% endif %}
                {% if is_model_under %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              {% set pov = (r.get('p_over') or 0) %}
              {% set pun = (r.get('p_under') or 0) %}
              {% set ppush = r.get('p_push') %}
              {% if ppush is none %}
                {% set push = 1 - pov - pun %}
              {% else %}
                {% set push = ppush %}
              {% endif %}
              {% if push < 0 %}{% set push = 0 %}{% endif %}
              <div class="chip neutral">Push Â· {{ '%.1f' % (100*push) }}%</div>
            </div>
            <div class="row chips">
              <div class="chip title">Puck Line</div>
              {% set ev_apl = r['ev_away_pl_+1.5'] if 'ev_away_pl_+1.5' in r else None %}
              {% set ev_hpl = r['ev_home_pl_-1.5'] if 'ev_home_pl_-1.5' in r else None %}
              {% set is_model_apl = (r.get('model_pick_pl') == 'Away +1.5') %}
              {% set is_model_hpl = (r.get('model_pick_pl') == 'Home -1.5') %}
              <div class="chip {{ 'positive' if (ev_apl is not none and ev_apl > 0) else ('negative' if (ev_apl is not none and ev_apl < 0) else 'neutral') }} {{ 'model-pick' if is_model_apl else '' }}">
                Away +1.5 {% if r['disp_away_pl_+1.5_odds'] is defined and r['disp_away_pl_+1.5_odds'] is not none %}{{ r['disp_away_pl_+1.5_odds'] }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r['p_away_pl_+1.5']) }}%
                {% if r['disp_away_pl_+1.5_odds'] is defined and r['disp_away_pl_+1.5_odds'] is not none %}
                <span class="book-badge" title="{{ r['disp_away_pl_+1.5_book'] if (r['disp_away_pl_+1.5_book'] is string) else 'DraftKings' }}">{{ ((r['disp_away_pl_+1.5_book'] if (r['disp_away_pl_+1.5_book'] is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_apl is not none %}<span class="ev-badge {{ 'pos' if ev_apl > 0 else ('neg' if ev_apl < 0 else 'neu') }}">EV {{ ('+' if ev_apl > 0 else '') ~ ('%.1f' % (100*ev_apl)) }}%</span>{% endif %}
                {% if is_model_apl %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_hpl is not none and ev_hpl > 0) else ('negative' if (ev_hpl is not none and ev_hpl < 0) else 'neutral') }} {{ 'model-pick' if is_model_hpl else '' }}">
                Home -1.5 {% if r['disp_home_pl_-1.5_odds'] is defined and r['disp_home_pl_-1.5_odds'] is not none %}{{ r['disp_home_pl_-1.5_odds'] }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*r['p_home_pl_-1.5']) }}%
                {% if r['disp_home_pl_-1.5_odds'] is defined and r['disp_home_pl_-1.5_odds'] is not none %}
                <span class="book-badge" title="{{ r['disp_home_pl_-1.5_book'] if (r['disp_home_pl_-1.5_book'] is string) else 'DraftKings' }}">{{ ((r['disp_home_pl_-1.5_book'] if (r['disp_home_pl_-1.5_book'] is string) else 'DK') | upper)[:2] }}</span>
                {% endif %}
                {% if ev_hpl is not none %}<span class="ev-badge {{ 'pos' if ev_hpl > 0 else ('neg' if ev_hpl < 0 else 'neu') }}">EV {{ ('+' if ev_hpl > 0 else '') ~ ('%.1f' % (100*ev_hpl)) }}%</span>{% endif %}
                {% if is_model_hpl %}<span class="model-badge" title="Model pick">PICK</span>{% endif %}
              </div>
              {% if not has_any_odds %}
              <div class="chip neutral">No odds available yet</div>
              {% endif %}
            </div>
            {# First 10 minutes market (Yes/No) if odds present #}
            {% set has_f10 = (r.get('f10_yes_odds') is not none) or (r.get('f10_no_odds') is not none) %}
            {% if has_f10 %}
            <div class="row chips">
              <div class="chip title">First 10 Minutes</div>
              {% set p_yes = r.get('p_f10_yes') if r.get('p_f10_yes') is not none else (r.get('first_10min_prob') if r.get('first_10min_prob') is not none else (1 - (2.71828 ** (-(r.get('first_10min_proj') or 0))))) %}
              {% set p_no = (1 - (p_yes or 0)) %}
              {% set ev_yes = r.get('ev_f10_yes') %}
              {% set ev_no = r.get('ev_f10_no') %}
              <div class="chip {{ 'positive' if (ev_yes is not none and ev_yes > 0) else ('negative' if (ev_yes is not none and ev_yes < 0) else 'neutral') }}">
                Yes {% if r.get('f10_yes_odds') is not none %}{{ r.get('f10_yes_odds') }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*(p_yes or 0)) }}%
                {% if ev_yes is not none %}<span class="ev-badge {{ 'pos' if ev_yes > 0 else ('neg' if ev_yes < 0 else 'neu') }}">EV {{ ('+' if ev_yes > 0 else '') ~ ('%.1f' % (100*ev_yes)) }}%</span>{% endif %}
              </div>
              <div class="chip {{ 'positive' if (ev_no is not none and ev_no > 0) else ('negative' if (ev_no is not none and ev_no < 0) else 'neutral') }}">
                No {% if r.get('f10_no_odds') is not none %}{{ r.get('f10_no_odds') }}{% else %}â€”{% endif %}
                Â· {{ '%.1f' % (100*(p_no or 0)) }}%
                {% if ev_no is not none %}<span class="ev-badge {{ 'pos' if ev_no > 0 else ('neg' if ev_no < 0 else 'neu') }}">EV {{ ('+' if ev_no > 0 else '') ~ ('%.1f' % (100*ev_no)) }}%</span>{% endif %}
              </div>
            </div>
            {# First-10 component splits: show how each side's scoring interacts with opponent allowing #}
            {% set _hs = r.get('p_f10_home_scores') %}
            {% set _aa = r.get('p_f10_away_allows') %}
            {% set _as = r.get('p_f10_away_scores') %}
            {% set _ha = r.get('p_f10_home_allows') %}
            {% if _hs is not none and _aa is not none and _as is not none and _ha is not none %}
            <div class="row chips">
              <div class="chip title">First 10 splits</div>
              <div class="chip neutral">
                Home score vs Away allow Â· {{ '%.1f' % (100 * (1 - (1 - (_hs or 0)) * (1 - (_aa or 0)))) }}%
              </div>
              <div class="chip neutral">
                Away score vs Home allow Â· {{ '%.1f' % (100 * (1 - (1 - (_as or 0)) * (1 - (_ha or 0)))) }}%
              </div>
            </div>
            {% endif %}
            {% endif %}

            {# Period totals chips for P1..P3 when lines/odds exist #}
            {% for pn in [1,2,3] %}
              {% set line = r.get('p' ~ pn ~ '_total_line') %}
              {% set has_pt = (line is not none) and ((r.get('p' ~ pn ~ '_over_odds') is not none) or (r.get('p' ~ pn ~ '_under_odds') is not none)) %}
              {% if has_pt %}
              <div class="row chips">
                <div class="chip title">Period {{ pn }} Total {{ '%.1f' % line if line is not none else '' }}</div>
                {% set pov = r.get('p' ~ pn ~ '_over_prob') %}
                {% set pun = r.get('p' ~ pn ~ '_under_prob') %}
                {% set evo = r.get('ev_p' ~ pn ~ '_over') %}
                {% set evu = r.get('ev_p' ~ pn ~ '_under') %}
                <div class="chip {{ 'positive' if (evo is not none and evo > 0) else ('negative' if (evo is not none and evo < 0) else 'neutral') }}">
                  Over {% if r.get('p' ~ pn ~ '_over_odds') is not none %}{{ r.get('p' ~ pn ~ '_over_odds') }}{% else %}â€”{% endif %}
                  Â· {{ '%.1f' % (100*(pov or 0)) }}%
                  {% if evo is not none %}<span class="ev-badge {{ 'pos' if evo > 0 else ('neg' if evo < 0 else 'neu') }}">EV {{ ('+' if evo > 0 else '') ~ ('%.1f' % (100*evo)) }}%</span>{% endif %}
                </div>
                <div class="chip {{ 'positive' if (evu is not none and evu > 0) else ('negative' if (evu is not none and evu < 0) else 'neutral') }}">
                  Under {% if r.get('p' ~ pn ~ '_under_odds') is not none %}{{ r.get('p' ~ pn ~ '_under_odds') }}{% else %}â€”{% endif %}
                  Â· {{ '%.1f' % (100*(pun or 0)) }}%
                  {% if evu is not none %}<span class="ev-badge {{ 'pos' if evu > 0 else ('neg' if evu < 0 else 'neu') }}">EV {{ ('+' if evu > 0 else '') ~ ('%.1f' % (100*evu)) }}%</span>{% endif %}
                </div>
              </div>
              {% endif %}
            {% endfor %}
            <div class="row details">
              <div class="detail-col">
                <div>
                  {% set mt = r.get('model_total') %}
                  {% if mt is not none %}Model Total: <strong>{{ '%.2f' % mt }}</strong>{% endif %}
                  {% if is_final_state and r.get('actual_total') is not none %} Â· Actual Total: <strong>{{ '%.2f' % r.get('actual_total') }}</strong>{% endif %}
                  {% if is_final_state and r.get('total_diff') is not none %} Â· Diff: <strong>{{ '%.2f' % r.get('total_diff') }}</strong>{% endif %}
                </div>
                {% set winner_actual = r.get('winner_actual') %}
                {% set winner_show = winner_actual and (winner_actual|string)|lower not in ('nan','none','') and is_final_state %}
                <div>Win Prob: Away {{ '%.1f' % (100*r.p_away_ml) }}% / Home {{ '%.1f' % (100*r.p_home_ml) }}%{% if winner_show %} Â· Winner: <strong>{{ winner_actual }}</strong> <span class="mark {{ 'ok' if r.get('winner_correct') else 'bad' }}">{{ 'âœ“' if r.get('winner_correct') else 'âœ—' }}</span>{% endif %}</div>
              </div>
            </div>
            {% if r.get('totals_pick') or r.get('ats_pick') %}
            <div class="row details">
              <div class="detail-col">
                {% if r.get('totals_pick') %}
                {% set res_total = r.get('result_total') %}
                {% set show_totals_result = is_final_state and res_total and (res_total|string)|lower not in ('nan','none','') %}
                <div>Totals Pick: <strong>{{ r.get('totals_pick') }}</strong>{% if r.get('totals_edge_pts') is not none %} (edge {{ '%.2f' % r.get('totals_edge_pts') }} pts){% endif %}{% if show_totals_result %} Â· Result: <strong>{{ res_total }}</strong> {% if res_total == 'Push' %}<span class="mark push">â€“</span>{% else %}<span class="mark {{ 'ok' if r.get('totals_pick_correct') else 'bad' }}">{{ 'âœ“' if r.get('totals_pick_correct') else 'âœ—' }}</span>{% endif %}{% endif %}</div>
                {% endif %}
                {% if r.get('ats_pick') %}
                {% set res_ats = r.get('result_ats') %}
                {% set show_ats_result = is_final_state and res_ats and (res_ats|string)|lower not in ('nan','none','') %}
                <div>ATS Pick: <strong>{{ 'Home -1.5' if r.get('ats_pick') == 'home_-1.5' else 'Away +1.5' }}</strong>{% if r.get('ats_edge_pts') is not none %} (edge {{ '%.2f' % r.get('ats_edge_pts') }} pts){% endif %}{% if show_ats_result %} Â· Result: <strong>{{ 'Home -1.5' if r.get('result_ats') == 'home_-1.5' else 'Away +1.5' }}</strong> <span class="mark {{ 'ok' if r.get('ats_pick_correct') else 'bad' }}">{{ 'âœ“' if r.get('ats_pick_correct') else 'âœ—' }}</span>{% endif %}</div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            {% if r.disp_over_odds is defined or r.disp_home_ml_odds is defined %}
            <div class="row details small">
              <div class="detail-col">
                <div>
                  Lines: ML {% if r.disp_home_ml_odds is not none and r.disp_away_ml_odds is not none %}H {{ r.disp_home_ml_odds }} / A {{ r.disp_away_ml_odds }}{% else %}â€”{% endif %}
                  Â· Total {% if r.disp_total_line_used is defined and r.disp_total_line_used is not none %}{{ '%.1f' % r.disp_total_line_used }}{% else %}â€”{% endif %}
                  Â· PL Â±1.5
                </div>
              </div>
            </div>
            {% endif %}
            {% if r.get('rec_market') %}
            <div class="row details">
              <div class="detail-col">
                <div class="rec-pill {{ 'ok' if r.get('rec_success') else ('push' if r.get('rec_result') == 'Push' else ('')) }}">
                  Recommendation: <strong>{{ r.get('rec_label') }}</strong>
                  {% if r.get('rec_confidence') %} <span class="rec-conf {{ r.get('rec_confidence')|lower }}">{{ r.get('rec_confidence') }}</span>{% endif %}
                  Â· EV {% if r.get('rec_ev') is not none %}{{ ('+' if r.get('rec_ev') > 0 else '') ~ ('%.1f' % (100*r.get('rec_ev'))) }}%{% else %}â€”{% endif %}
                  {% if r.get('rec_odds') is not none %} Â· {{ r.get('rec_odds') }}{% endif %}
                  {% if r.get('rec_book') %} @ {{ r.get('rec_book') }}{% endif %}
                  {% if r.get('rec_result') %} Â· Result: <strong>{{ r.get('rec_result') }}</strong>{% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            {% if r.get('model_pick') and r.get('model_pick_prob') is not none %}
            <div class="row details small">
              <div class="detail-col">
                <div class="model-pill">Model Pick: <strong>{{ r.get('model_pick') }}</strong> Â· {{ '%.1f' % (100*r.get('model_pick_prob')) }}%</div>
              </div>
            </div>
            {% endif %}
            <div class="row details small">
              <div class="detail-col">
                <div>Debug: {{ date }} | {{ r.home_abbr }}-{{ r.away_abbr }} | gamePk={{ r.gamePk if r.get('gamePk') else 'â€”' }} | hasOdds={{ 1 if has_any_odds else 0 }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    </div>
  </main>
  {% include '_footer.html' %}
  <footer>
    <div class="container">
      <div class="footer-note">
        <span>Last odds update: <strong><span id="luOdds">{{ last_updates.predictions_iso if last_updates and last_updates.predictions_iso else '' }}</span></strong></span>
        <span class="sep">|</span>
        <span>Last recommendations update: <strong><span id="luRecs">{{ last_updates.recommendations_iso if last_updates and last_updates.recommendations_iso else '' }}</span></strong></span>
      </div>
    </div>
  </footer>
</body>
<script>
(function() {
  const qsDate = new URLSearchParams(window.location.search).get('date');
  const date = qsDate || '{{ date }}';
  const liveNow = '{{ 1 if live_now else 0 }}' === '1';
  const isSettled = '{{ 1 if settled else 0 }}' === '1';
  const lastEl = document.getElementById('last-updated');
  let lastVal = null;
  const pollIntervalMs = 60000; // 60s last-updated polling
  const liveIntervalMs = 15000; // 15s live scoreboard polling
  const refreshOddsMs = 600000; // 10m background odds refresh during window
  const pauseBtn = document.getElementById('pauseBtn');
  // injectOdds button removed
  const refetchBtn = document.getElementById('refreshOddsBtn');

  // Format all game dates into the user's local timezone
  (function formatLocalTimes(){
    const nodes = Array.from(document.querySelectorAll('.card[data-game-date] .js-local-time'));
    const fmt = new Intl.DateTimeFormat(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: true
    });
    nodes.forEach(node => {
      const card = node.closest('.card');
      const iso = card ? card.getAttribute('data-game-date') : null;
      if (!iso) return;
      const d = new Date(iso);
      if (isNaN(d)) {
        node.textContent = iso;
        return;
      }
      node.textContent = fmt.format(d);
    });
  })();

  // If settled, disable toggle and fully skip any background polling/network calls
  if (isSettled) {
    if (pauseBtn) { try { pauseBtn.disabled = true; pauseBtn.textContent = 'Settled'; } catch(_){} }
    // Still show last-updated once (already rendered server-side note). No timers.
    return;
  }

  async function updateLastUpdated() {
    try {
      const res = await fetch(`/api/last-updated?date=${encodeURIComponent(date)}`, { cache: 'no-store' });
      if (res.ok) {
        const data = await res.json();
        const val = data.last_modified || null;
        if (lastEl) {
          lastEl.textContent = 'Last updated: ' + (val ? new Date(val).toLocaleString() : 'â€”');
        }
        return val;
      }
    } catch (e) {}
    return null;
  }
  function anyOddsMissing() {
    const cards = Array.from(document.querySelectorAll('.card[data-has-odds]'));
    if (!cards.length) return true;
    return cards.some(el => el.getAttribute('data-has-odds') !== '1');
  }
  function anyHasOdds() {
    const cards = Array.from(document.querySelectorAll('.card[data-has-odds]'));
    if (!cards.length) return false;
    return cards.some(el => el.getAttribute('data-has-odds') === '1');
  }


  function computeGameWindow() {
    const times = Array.from(document.querySelectorAll('.card[data-game-date]'))
      .map(el => new Date(el.getAttribute('data-game-date')))
      .filter(d => !isNaN(d));
    if (!times.length) return null;
    const earliest = new Date(Math.min.apply(null, times));
    const latest = new Date(Math.max.apply(null, times));
    // Define a polling window: 90 min before first game to 4 hours after last start
    const start = new Date(earliest.getTime() - 90*60*1000);
    const end = new Date(latest.getTime() + 4*60*60*1000);
    return { start, end };
  }

  async function maybeReloadOnChange() {
    const val = await updateLastUpdated();
    if (lastVal && val && val !== lastVal) {
      // Data file changed; reload to update cards
      window.location.reload();
      return;
    }
    if (val) lastVal = val;
  }

  async function refreshOdds() {
    if (isSettled) return; // never refresh odds for settled slates
    try {
      const url = liveNow ? `/api/refresh-odds?date=${encodeURIComponent(date)}&backfill=1` : `/api/refresh-odds?date=${encodeURIComponent(date)}`;
      await fetch(url, { method: 'GET', cache: 'no-store' });
    } catch (e) {}
  }

  // Move bootstrap logic inside opt-in auto-update; when disabled we skip all background network calls.
  async function bootstrapAuto() {
    const v = await updateLastUpdated();
    lastVal = v;
    if (!isSettled && !liveNow) {
      // One-shot odds fill only if missing
      if (anyOddsMissing()) {
        await refreshOdds();
        setTimeout(async () => {
          const nv = await updateLastUpdated();
            if (nv && lastVal && nv !== lastVal) {
              window.location.reload();
            }
        }, 3000);
      } else if (anyHasOdds()) {
        // Capture openers once (idempotent)
        try { await fetch(`/api/capture-openers?date=${encodeURIComponent(date)}`, { method: 'POST' }); } catch(_){}
      }
    }
  }

  // manual inject removed

  // Manual refetch handler (current day)
  if (refetchBtn) {
    refetchBtn.addEventListener('click', async () => {
      try {
        refetchBtn.disabled = true;
        const label = refetchBtn.textContent;
        refetchBtn.textContent = 'Refetchingâ€¦';
        const before = await updateLastUpdated();
  const url = liveNow ? `/api/refresh-odds?date=${encodeURIComponent(date)}&backfill=1` : `/api/refresh-odds?date=${encodeURIComponent(date)}`;
  await fetch(url, { method: 'GET', cache: 'no-store' });
        setTimeout(async () => {
          const after = await updateLastUpdated();
          refetchBtn.disabled = false;
          refetchBtn.textContent = label;
          if (before && after && before !== after) {
            window.location.reload();
          }
        }, 2500);
      } catch (_) {
        try { refetchBtn.disabled = false; } catch {}
      }
    });
  }

  const windowRange = computeGameWindow();
  let pollTimer = null;
  let oddsTimer = null;
  let liveTimer = null;
  function inWindow() {
    // If we have a computed window with real times use it; else allow full day.
    if (!windowRange) return true; // fallback: always allow
    const now = new Date();
    // If window collapsed (e.g., all start times parsed as midnight) widen to entire day
    if (windowRange.start.getTime() === windowRange.end.getTime()) return true;
    return now >= windowRange.start && now <= windowRange.end;
  }
  function startLoops() {
    if (isSettled) return; // disable auto loops on settled slates
    // Run bootstrap + first scoreboard refresh only the first time loops engage
    const first = !pollTimer && !oddsTimer && !liveTimer;
    if (!pollTimer) pollTimer = setInterval(maybeReloadOnChange, pollIntervalMs);
    if (!oddsTimer) oddsTimer = setInterval(refreshOdds, refreshOddsMs);
    if (!liveTimer) liveTimer = setInterval(refreshLive, liveIntervalMs);
    if (first) {
      // Initial immediate actions
      bootstrapAuto();
      refreshLive();
    }
  }
  function stopLoops() {
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    if (oddsTimer) { clearInterval(oddsTimer); oddsTimer = null; }
    if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
  }

  // Engage loops only during game-time window
  function shouldAutoUpdate() {
    // Now opt-in: only auto update (poll + live scoreboard + odds refresh interval) if explicitly set to 'on'
    try { return localStorage.getItem('autoUpdate') === 'on'; } catch { return false; }
  }
  // Always start loops immediately (unless paused later)
  startLoops();
  let paused = false;
  function updatePauseUI() {
    if (!pauseBtn) return;
    pauseBtn.textContent = paused ? 'Resume' : 'Pause';
    pauseBtn.title = paused ? 'Resume live updates' : 'Pause live updates';
    pauseBtn.classList.toggle('paused', paused);
  }
  if (pauseBtn) {
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      if (paused) {
        stopLoops();
      } else {
        startLoops();
        refreshLive(true);
      }
      updatePauseUI();
    });
    updatePauseUI();
  }
  // Remove legacy auto-update re-check loop

  window.addEventListener('beforeunload', stopLoops);

  async function refreshLive(isOneShot=false) {
    try {
  if (paused) return; // do not fetch while paused
  const res = await fetch(`/api/scoreboard?date=${encodeURIComponent(date)}`, { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();
      // Heartbeat + scoreboard last poll timestamp
      try {
        const dot = document.getElementById('hbDot');
        const sbEl = document.getElementById('last-sb');
        if (dot) {
          dot.classList.remove('pulse');
          // Force reflow so animation retriggers reliably
          void dot.offsetWidth;
          dot.classList.add('pulse');
        }
        if (sbEl) {
          const now = new Date();
          sbEl.textContent = 'SB: ' + now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        }
      } catch(_){}
      let fetchedAt = null;
      if (Array.isArray(data) && data.length>0) {
        fetchedAt = data[0].fetched_at || null;
      }
      // Removed scoreboard timestamp banner per user request
      // Index by gamePk and by abbr pair
      const byPk = new Map();
      const byAbbr = new Map();
      for (const g of data) {
        if (g.gamePk) byPk.set(String(g.gamePk), g);
        const key = (g.home_abbr || '') + '|' + (g.away_abbr || '');
        byAbbr.set(key, g);
      }
      const cards = document.querySelectorAll('.card');
      cards.forEach(async (card) => {
        const pk = card.getAttribute('data-gamepk');
        const h = (card.getAttribute('data-home-abbr') || '').toUpperCase();
        const a = (card.getAttribute('data-away-abbr') || '').toUpperCase();
        let g = null;
        if (pk && byPk.has(pk)) g = byPk.get(pk);
        if (!g) {
          const key = h + '|' + a;
          if (byAbbr.has(key)) g = byAbbr.get(key);
        }
        if (!g) return;
        // Update state text and time-left
        const stateEl = card.querySelector('.row.head .state');
        const timeEl = card.querySelector('.row.head .time-left');
        if (stateEl) {
          const st = (g.gameState || '').toUpperCase();
          stateEl.textContent = g.gameState || '';
          stateEl.classList.toggle('crit', st.includes('CRIT'));
        }
        const periodEl = card.querySelector('.row.head .period-pill');
        if (periodEl) {
          const st = (g.gameState || '').toUpperCase();
          let txt = '';
          if (g.period_disp) txt = g.period_disp;
          else if (st.includes('FINAL')) txt = 'Final';
          else if (g.period) txt = 'P'+g.period;
          else if (st.includes('LIVE') || st.includes('IN') || st.includes('PROGRESS') || st.includes('CRIT')) txt = 'Live';
          periodEl.textContent = txt;
          periodEl.classList.toggle('crit', st.includes('CRIT'));
          if (g.intermission) periodEl.classList.add('int'); else periodEl.classList.remove('int');
        }
        if (timeEl) {
          const st = (g.gameState || '').toUpperCase();
          if (st.includes('FINAL')) {
            timeEl.textContent = 'â€”';
          } else if (g.clock) {
            timeEl.textContent = String(g.clock);
          } else if (g.intermission) {
            timeEl.textContent = 'INT';
          } else if (st.includes('LIVE') || st.includes('IN') || st.includes('PROGRESS') || st.includes('CRIT')) {
            timeEl.textContent = 'â€”';
          } else {
            timeEl.textContent = 'â€”';
          }
          timeEl.classList.toggle('crit', st.includes('CRIT'));
        }
        // Update live scores (do not overwrite projections)
        const ha = card.querySelector('.js-live-home');
        const aa = card.querySelector('.js-live-away');
        if (ha && g.home_goals != null) ha.textContent = String(g.home_goals);
        if (aa && g.away_goals != null) aa.textContent = String(g.away_goals);

        // If the game is LIVE or FINAL and we haven't captured closing odds yet, do it once
        try {
          const already = card.getAttribute('data-close-captured') === '1';
          const st = (g.gameState || '').toUpperCase();
          const isLive = st.includes('LIVE') || st.includes('IN') || st.includes('PROGRESS') || st.includes('FINAL');
          if (!already && isLive && h && a) {
            const url = `/api/capture-closing?date=${encodeURIComponent(date)}&home_abbr=${encodeURIComponent(h)}&away_abbr=${encodeURIComponent(a)}`;
            await fetch(url, { method: 'POST' });
            card.setAttribute('data-close-captured', '1');
          }
        } catch (_) { /* ignore capture errors */ }
      });
      // If this was a one-shot and many live games still have blank period, schedule a retry
      if (isOneShot) {
        const pills = Array.from(document.querySelectorAll('.row.head .period-pill'));
        const blanks = pills.filter(el=>!el.textContent);
        if (blanks.length>0) setTimeout(()=>refreshLive(true), 5000);
        // second quicker retry if still missing clock but period present
        const liveNoClock = Array.from(document.querySelectorAll('.card')).some(card=>{
          const st = (card.querySelector('.row.head .state')||{}).textContent || '';
          const stU = st.toUpperCase();
          const periodTxt = (card.querySelector('.row.head .period-pill')||{}).textContent || '';
          const timeTxt = (card.querySelector('.row.head .time-left')||{}).textContent || '';
          return periodTxt && !timeTxt && (stU.includes('LIVE')||stU.includes('PROGRESS')); });
        if (liveNoClock) setTimeout(()=>refreshLive(true), 2000);
      }
    } catch (e) { /* ignore */ }
  }
  // When auto-update is off, only the one-shot refreshLive above will have run (if within window).
})();
// Footer time localization
(function(){
  function fmtLocal(iso){
    if(!iso) return 'â€”';
    try{
      const d = new Date(iso);
      if (isNaN(d)) return 'â€”';
      return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch(e){ return 'â€”'; }
  }
  const o = document.getElementById('luOdds');
  const r = document.getElementById('luRecs');
  if (o) o.textContent = fmtLocal(o.textContent.trim());
  if (r) r.textContent = fmtLocal(r.textContent.trim());
})();
// Theme toggle handler
(function() {
  const btn = document.getElementById('themeToggle');
  if (!btn) return;
  btn.addEventListener('click', function() {
    const html = document.documentElement;
    html.classList.toggle('light');
    try {
      localStorage.setItem('theme', html.classList.contains('light') ? 'light' : 'dark');
    } catch (e) {}
  });
})();
</script>
</html>
