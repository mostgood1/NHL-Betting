<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHL Betting - Player Props</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #2a2a2a; text-align: left; }
    .ev-pos { color: #57d657; font-weight: 600; }
    .ev-neg { color: #ff6b6b; }
    .controls { display: flex; gap: 8px; align-items: center; }
    .controls input, .controls select { background: #1e1e1e; color: #f0f0f0; border: 1px solid #333; border-radius: 4px; padding: 6px 8px; }
    .controls label { font-size: 12px; color: #bbb; }
  .controls .spacer { flex: 1 1 auto; }
  .th-sort { cursor: pointer; -webkit-user-select: none; user-select: none; }
  .notice { margin:10px 0; padding:8px 12px; border:1px solid #2a3a7a; border-radius:8px; background:#0f1530; color:#cfe0ff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Player Props</h1>
      {% if notice %}
      <div class="notice">{{ notice }}</div>
      {% endif %}
      <div class="nav">
        <a href="/">Cards</a>
        <span> | </span>
        <a href="/recommendations">Recs</a>
        <span> | </span>
  <a href="/props">Props</a>
        <span> | </span>
        <a href="/props/teams">Teams</a>
        <span> | </span>
  <a href="/props/recommendations">Props Recs</a>
        <span> | </span>
  <a id="dlcsv" href="{{ download_href or '/props/projections.csv' }}">Download CSV</a>
      </div>
      <div class="controls">
        <label>Date (ET)
          <input id="date" type="date" value="{{ date }}" />
        </label>
        <label>Market
          <select id="market">
            <option value="" {{ 'selected' if (market or '')=='' else '' }}>All</option>
            <option value="SOG" {{ 'selected' if (market or '')=='SOG' else '' }}>SOG</option>
            <option value="SAVES" {{ 'selected' if (market or '')=='SAVES' else '' }}>Saves</option>
            <option value="GOALS" {{ 'selected' if (market or '')=='GOALS' else '' }}>Goals</option>
            <option value="ASSISTS" {{ 'selected' if (market or '')=='ASSISTS' else '' }}>Assists</option>
            <option value="POINTS" {{ 'selected' if (market or '')=='POINTS' else '' }}>Points</option>
          </select>
        </label>
        <label>Team
          <select id="team">
            <option value="" {{ 'selected' if (team or '')=='' else '' }}>All</option>
            {% for t in teams or [] %}
              <option value="{{ t }}" {{ 'selected' if (team or '')==t else '' }}>{{ t }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Min EV
          <input id="min_ev" type="number" step="0.01" value="{{ '%.2f' % (min_ev or 0.0) }}" />
        </label>
        <label>Top N
          <input id="top" type="number" step="1" value="{{ top or 50 }}" />
        </label>
        <label>Sort
          <select id="sort">
            <option value="ev_desc" {{ 'selected' if (sort or '')=='ev_desc' else '' }}>EV desc</option>
            <option value="ev_asc" {{ 'selected' if (sort or '')=='ev_asc' else '' }}>EV asc</option>
            <option value="p_over_desc" {{ 'selected' if (sort or '')=='p_over_desc' else '' }}>P(Over) desc</option>
            <option value="p_over_asc" {{ 'selected' if (sort or '')=='p_over_asc' else '' }}>P(Over) asc</option>
            <option value="lambda_desc" {{ 'selected' if (sort or '')=='lambda_desc' else '' }}>Proj λ desc</option>
            <option value="lambda_asc" {{ 'selected' if (sort or '')=='lambda_asc' else '' }}>Proj λ asc</option>
            <option value="name" {{ 'selected' if (sort or '')=='name' else '' }}>Player</option>
            <option value="team" {{ 'selected' if (sort or '')=='team' else '' }}>Team</option>
            <option value="market" {{ 'selected' if (sort or '')=='market' else '' }}>Market</option>
            <option value="line" {{ 'selected' if (sort or '')=='line' else '' }}>Line</option>
            <option value="book" {{ 'selected' if (sort or '')=='book' else '' }}>Book</option>
          </select>
        </label>
        <button onclick="reloadPage()">Apply</button>
      </div>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th class="th-sort" onclick="setSort('market')">Market</th>
          <th class="th-sort" onclick="setSort('name')">Player</th>
          <th class="th-sort" onclick="setSort('team')">Team</th>
          <th class="th-sort" onclick="setSort('line')">Line</th>
          <th>Odds (Over)</th>
          <th>Odds (Under)</th>
          <th class="th-sort" onclick="toggleSort('lambda')">Proj λ</th>
          <th class="th-sort" onclick="toggleSort('p_over')">P(Over)</th>
          <th class="th-sort" onclick="toggleSort('ev')">EV (Over)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.market }}</td>
            <td>{{ r.player }}</td>
            <td>{{ r.team if r.team is defined else '' }}</td>
            <td>{{ r.line }}</td>
            <td>{{ r.over_price }}</td>
            <td>{{ r.under_price }}</td>
            <td>{{ '%.2f' % r.proj_lambda }}</td>
            <td>{{ '%.1f' % (r.p_over * 100) }}%</td>
            <td class="{{ 'ev-pos' if r.ev_over >= 0 else 'ev-neg' }}">{{ '%.3f' % r.ev_over }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    // Update the download link with the selected date
    (function(){
      try {
        const a = document.getElementById('dlcsv');
        const d = document.getElementById('date');
        if (a && d && d.value) {
          const u = new URL(a.getAttribute('href'), window.location.origin);
          u.searchParams.set('date', d.value);
          a.setAttribute('href', u.pathname + '?' + u.searchParams.toString());
        }
      } catch(e) {}
    })();
    function reloadPage() {
      const params = new URLSearchParams(window.location.search);
      const date = document.getElementById('date').value;
      const market = document.getElementById('market').value;
      const team = document.getElementById('team').value;
      const min_ev = document.getElementById('min_ev').value || '0';
      const top = document.getElementById('top').value || '50';
      const sort = document.getElementById('sort').value || 'ev_desc';
      if (date) params.set('date', date); else params.delete('date');
      if (market) params.set('market', market); else params.delete('market');
      if (team) params.set('team', team); else params.delete('team');
      params.set('min_ev', min_ev);
      params.set('top', top);
      if (sort) params.set('sort', sort); else params.delete('sort');
      window.location.search = params.toString();
    }
    function setSort(key){
      const map = { market: 'market', name: 'name', team: 'team', line: 'line', book: 'book' };
      const val = map[key] || 'ev_desc';
      document.getElementById('sort').value = val;
      reloadPage();
    }
    function toggleSort(metric){
      const sel = document.getElementById('sort');
      const cur = sel.value;
      if(metric==='ev') sel.value = (cur==='ev_desc') ? 'ev_asc' : 'ev_desc';
      else if(metric==='p_over') sel.value = (cur==='p_over_desc') ? 'p_over_asc' : 'p_over_desc';
      else if(metric==='lambda') sel.value = (cur==='lambda_desc') ? 'lambda_asc' : 'lambda_desc';
      reloadPage();
    }
  </script>
</body>
</html>
