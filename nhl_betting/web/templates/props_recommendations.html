<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHL – Props Recommendations</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    :root{--card-bg:#0f1115;--border:#262a33;--muted:#b9c2d0;--ev-bg:#113a34;--ev-fg:#a7f3d0;--ev-bd:rgba(12,148,106,.35)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .card{position:relative;border:1px solid var(--border);border-radius:12px;padding:12px 12px 10px;background:var(--card-bg)}
    .row{display:flex;align-items:center;gap:10px}
    .logo{position:absolute;top:10px;right:10px;width:32px;height:32px;object-fit:contain;opacity:.95}
    .avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .title{font-weight:700;font-size:15px;line-height:1.2}
    .subtitle{font-size:12px}
    .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:2px 6px;margin-left:6px;white-space:nowrap}
    .ev{display:inline-block;background:var(--ev-bg);color:var(--ev-fg);border:1px solid var(--ev-bd);border-radius:999px;padding:2px 6px;font-weight:600;font-size:12px}
    .muted{opacity:.9;color:var(--muted);font-size:12px}
    .ladders{margin-top:8px}
    .lad{display:flex;justify-content:space-between;border:1px dashed var(--border);border-radius:8px;padding:6px 8px;margin-top:6px}
    .lad .side{font-weight:600}
    .row-market{margin-top:10px;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .hint-more{margin-left:8px}
    .proj-strip{margin-top:6px;font-size:12px;color:var(--muted)}
    .proj-strip .label{opacity:.9}
    .proj-strip .dot{opacity:.5;margin:0 6px}
    .debug-meta{font-size:11px;color:#6fa}
  @media (min-width:1600px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="data:," />
  <script>
    function applyFilters(){
      const params = new URLSearchParams(window.location.search);
      const date = document.getElementById('date').value;
      const market = document.getElementById('market').value;
      const min_ev = document.getElementById('min_ev').value || '0';
      const top = document.getElementById('top').value || '200';
      const sortBy = document.getElementById('sortBy').value || 'ev_desc';
      const all = document.getElementById('all').checked ? '1' : '';
      if(date) params.set('date', date); else params.delete('date');
      if(market) params.set('market', market); else params.delete('market');
      params.set('min_ev', min_ev); params.set('top', top);
      if(sortBy) params.set('sortBy', sortBy); else params.delete('sortBy');
      if(all) params.set('all', all); else params.delete('all');
      window.location.search = params.toString();
    }
  </script>
  </head>
<body>
  <div class="container">
  {% macro fmt_price(v) -%}
    {%- if v is not none -%}
      {%- set i = v|int -%}
      {%- if i >= 0 -%}+{{ i }}{%- else -%}{{ i }}{%- endif -%}
    {%- else -%}—{%- endif -%}
  {%- endmacro %}
  <div class="nav"><a href="/">Cards</a> | <a href="/recommendations">Recs</a> | <a href="/props">Props</a> | <a href="/props/recommendations">Props Recs</a> | <a href="/props/reconciliation">Props Recon</a> | <a href="/props/stats-calibration">Props Cal</a></div>
    <h1>Props Recommendations</h1>
    <form class="filters" onsubmit="applyFilters(); return false;">
      <label>Date <input id="date" type="date" value="{{ date }}" /></label>
      <label>Market
        <select id="market">
          <option value="" {{ 'selected' if (market or '')=='' else '' }}>All</option>
          <option value="SOG" {{ 'selected' if market=='SOG' else '' }}>SOG</option>
          <option value="GOALS" {{ 'selected' if market=='GOALS' else '' }}>Goals</option>
          <option value="ASSISTS" {{ 'selected' if market=='ASSISTS' else '' }}>Assists</option>
          <option value="POINTS" {{ 'selected' if market=='POINTS' else '' }}>Points</option>
          <option value="SAVES" {{ 'selected' if market=='SAVES' else '' }}>Saves</option>
          <option value="BLOCKS" {{ 'selected' if market=='BLOCKS' else '' }}>Blocked Shots</option>
        </select>
      </label>
      <label>Min EV <input id="min_ev" type="number" step="0.01" value="{{ min_ev }}" /></label>
      <label>Top <input id="top" type="number" step="1" value="{{ top }}" /></label>
      <label>Sort
        <select id="sortBy">
          <option value="ev_desc" {{ 'selected' if (sortBy or '')=='ev_desc' else '' }}>EV desc</option>
          <option value="ev_asc" {{ 'selected' if (sortBy or '')=='ev_asc' else '' }}>EV asc</option>
          <option value="name" {{ 'selected' if (sortBy or '')=='name' else '' }}>Name</option>
          <option value="market" {{ 'selected' if (sortBy or '')=='market' else '' }}>Market</option>
        </select>
      </label>
      <label>Side
        <select id="side">
          <option value="both" {{ 'selected' if (side or '')=='both' else '' }}>Both</option>
          <option value="over" {{ 'selected' if (side or '')=='over' else '' }}>Over</option>
          <option value="under" {{ 'selected' if (side or '')=='under' else '' }}>Under</option>
        </select>
      </label>
      <label><input id="all" type="checkbox" {{ 'checked' if all else '' }} /> All</label>
      <button type="submit">Apply</button>
  <a class="button push-right" href="/props/recommendations.csv?date={{ date }}">Download CSV</a>
    </form>
    <div class="muted">
      {{ cards|length }} players{% if truncated %} (truncated){% endif %}
    {% if not truncated and not all %}<span class="hint-more">Use &all=1 or increase Top to see more.</span>{% endif %}
  {% if debug_info %}<br/><code class="debug-meta">{{ debug_info }}</code>{% endif %}
    </div>
    <div class="grid">
      {% for c in cards %}
        <div class="card">
          <div class="row">
            {% if c.photo or c.photo_src %}
              <img class="avatar" src="{{ c.photo_src or c.photo }}" alt="{{ c.player }}" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'42\' height=\'42\'><circle cx=\'21\' cy=\'14\' r=\'8\' fill=\'%23262a33\'/><rect x=\'9\' y=\'24\' width=\'24\' height=\'14\' rx=\'7\' fill=\'%23262a33\'/></svg>'" />
            {% endif %}
            <div>
              <div class="title">{{ c.player }}</div>
              <div class="muted subtitle">{{ c.team_abbr or c.team or '—' }}{% if c.position %} · {{ c.position }}{% endif %}</div>
              {# Single-line projections for SOG, Goals, Assists, Points #}
              {% if c.markets %}
                {% set ns = namespace(sog=none, goals=none, assists=none, points=none) %}
                {% for m in c.markets %}
                  {% if m.market == 'SOG' and m.proj is not none %}{% set ns.sog = m.proj %}{% endif %}
                  {% if m.market == 'GOALS' and m.proj is not none %}{% set ns.goals = m.proj %}{% endif %}
                  {% if m.market == 'ASSISTS' and m.proj is not none %}{% set ns.assists = m.proj %}{% endif %}
                  {% if m.market == 'POINTS' and m.proj is not none %}{% set ns.points = m.proj %}{% endif %}
                {% endfor %}
                <div class="proj-strip">
                  <span class="label">Proj:</span>
                  SOG {{ '%.2f' % ns.sog if ns.sog is not none else '—' }}
                  <span class="dot">•</span>
                  Goals {{ '%.2f' % ns.goals if ns.goals is not none else '—' }}
                  <span class="dot">•</span>
                  Assists {{ '%.2f' % ns.assists if ns.assists is not none else '—' }}
                  <span class="dot">•</span>
                  Points {{ '%.2f' % ns.points if ns.points is not none else '—' }}
                </div>
              {% endif %}
            </div>
            {% if c.team_logo %}
              <img class="logo" src="{{ c.team_logo }}" alt="{{ c.team_abbr }}" onerror="this.style.display='none'" />
            {% endif %}
          </div>
          {% if c.markets %}
            {% for m in c.markets %}
              {% if m.ladders and m.ladders|length > 0 %}
                <div class="ladders">
                  {% for l in m.ladders %}
                    <div class="lad">
                      <div><span class="badge">{{ m.market }}</span> {{ l.line }}</div>
                      <div class="side">{{ l.side or 'Over' }}{% if l.rec %} <span class="badge rec">REC</span>{% endif %}</div>
                      <div>O {{ fmt_price(l.over_price) }} · U {{ fmt_price(l.under_price) }}</div>
                      <div>{{ l.book or '—' }}</div>
                      <div>
                        <span class="ev">{{ '%.0f%%' % l.ev_pct if l.ev_pct is not none else ('%.0f%%' % (l.ev*100) if l.ev is not none else '—') }}</span>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</body>
</html>
