<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHL Betting - Recommendations</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .rec-wrap { padding: 18px 0; }
    .header { display: flex; align-items: center; justify-content: space-between; }
    .controls { display: flex; gap: 8px; align-items: center; }
    .controls input, .controls select { background: #1e1e1e; color: #f0f0f0; border: 1px solid #333; border-radius: 4px; padding: 6px 8px; }
    .controls label { font-size: 12px; color: #bbb; }
    .section { margin-top: 18px; }
    .section h2 { margin: 10px 0; font-size: 16px; color: #c9d3ff; }
    table.rec { width: 100%; border-collapse: collapse; }
    table.rec th, table.rec td { padding: 8px 10px; border-bottom: 1px solid #25316a; text-align: left; }
    .pill { display: inline-block; padding: 2px 6px; border-radius: 999px; background: #0f1530; border: 1px solid #25316a; font-size: 12px; color: #d5dbff; }
    .conf-badge { font-size:11px; font-weight:600; padding:2px 6px; border-radius:6px; display:inline-block; }
    .conf-high { background:#145025; color:#c9ffd8; border:1px solid #2e8a49; }
    .conf-medium { background:#253c6e; color:#d5e2ff; border:1px solid #3d5c9e; }
    .conf-low { background:#5a3a00; color:#ffe7c2; border:1px solid #a56b00; }
    .conf-other { background:#3d3d3d; color:#d0d0d0; border:1px solid #5a5a5a; }
    .export-btn { background:#243056; color:#dbe6ff; border:1px solid #384a7a; padding:6px 10px; border-radius:4px; cursor:pointer; }
    .export-btn:hover { background:#2d3d70; }
    .auto-refresh-label { font-size:12px; display:flex; align-items:center; gap:4px; }
    .book-badge { background: #243056; color: #cfe0ff; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 700; opacity: 0.9; }
    .meta { color: #9fb0ff; font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="container rec-wrap">
    <div class="header">
      <h1>NHL Betting – Recommendations</h1>
      <div class="controls">
        <label>Min EV
          <input id="min_ev" type="number" step="0.01" value="{{ min_ev }}" />
        </label>
        <div class="container">
          <h1>NHL Betting Recommendations</h1>
          <form method="get" class="filters">
            <label>Date <input type="date" name="date" value="{{ date or '' }}" /></label>
            <label>Min EV <input type="number" step="0.01" name="min_ev" value="{{ min_ev }}" /></label>
            <label>Top N <input type="number" name="top" value="{{ top }}" /></label>
            <label>Markets
              <select name="markets">
                <option value="all" {% if markets=='all' %}selected{% endif %}>All</option>
                <option value="moneyline" {% if markets=='moneyline' %}selected{% endif %}>Moneyline</option>
                <option value="totals" {% if markets=='totals' %}selected{% endif %}>Totals</option>
                <option value="puckline" {% if markets=='puckline' %}selected{% endif %}>Puck Line</option>
              </select>
            </label>
            <label>Bankroll <input type="number" step="1" name="bankroll" value="{{ bankroll }}" /></label>
            <label>Kelly Part <input type="number" step="0.05" name="kelly_fraction_part" value="{{ kelly_fraction_part }}" /></label>
            <label>High EV ≥ <input type="number" step="0.01" name="high_ev" value="{{ high_ev }}" /></label>
            <label>Med EV ≥ <input type="number" step="0.01" name="med_ev" value="{{ med_ev }}" /></label>
            <label>Sort By
              <select name="sort_by">
                <option value="ev" {% if sort_by=='ev' %}selected{% endif %}>EV</option>
                <option value="edge" {% if sort_by=='edge' %}selected{% endif %}>Edge</option>
                <option value="prob" {% if sort_by=='prob' %}selected{% endif %}>Model %</option>
                <option value="price" {% if sort_by=='price' %}selected{% endif %}>Price</option>
              </select>
            </label>
            <label class="auto-refresh-label"><input type="checkbox" id="autoRefreshBox" /> Auto-refresh</label>
            <button type="button" id="exportCsv" class="export-btn" title="Download current recommendations as CSV">Export CSV</button>
            <button type="submit">Apply</button>
          </form>

          <div class="top-bar">
            <div>Total Picks: {{ total_picks }}</div>
            <div>Markets: ML {{ counts.moneyline }}, Totals {{ counts.totals }}, PL {{ counts.puckline }}</div>
            <div>High ≥ {{ (high_ev*100)|round(1) }}% | Med ≥ {{ (med_ev*100)|round(1) }}%</div>
          </div>

          <div class="summary">
            <div class="summary-section">
              <h3>Overall</h3>
              <div>Wins/Losses/Pushes: {{ summary_overall.wins }}/{{ summary_overall.losses }}/{{ summary_overall.pushes }}</div>
              <div>Accuracy: {% if summary_overall.accuracy is not none %}{{ (summary_overall.accuracy*100)|round(1) }}%{% else %}-{% endif %}</div>
              <div>Total Stake: ${{ summary_overall.stake|round(2) }}</div>
              <div>P/L: ${{ summary_overall.pnl|round(2) }}</div>
              <div>ROI: {% if summary_overall.roi is not none %}{{ (summary_overall.roi*100)|round(1) }}%{% else %}-{% endif %}</div>
            </div>
            <div class="summary-section">
              <h3>High Confidence</h3>
              <div>Wins/Losses/Pushes: {{ summary_high.wins }}/{{ summary_high.losses }}/{{ summary_high.pushes }}</div>
              <div>Accuracy: {% if summary_high.accuracy is not none %}{{ (summary_high.accuracy*100)|round(1) }}%{% else %}-{% endif %}</div>
              <div>Total Stake: ${{ summary_high.stake|round(2) }}</div>
              <div>P/L: ${{ summary_high.pnl|round(2) }}</div>
              <div>ROI: {% if summary_high.roi is not none %}{{ (summary_high.roi*100)|round(1) }}%{% else %}-{% endif %}</div>
            </div>
            <div class="summary-section">
              <h3>Medium Confidence</h3>
              <div>Wins/Losses/Pushes: {{ summary_medium.wins }}/{{ summary_medium.losses }}/{{ summary_medium.pushes }}</div>
              <div>Accuracy: {% if summary_medium.accuracy is not none %}{{ (summary_medium.accuracy*100)|round(1) }}%{% else %}-{% endif %}</div>
              <div>Total Stake: ${{ summary_medium.stake|round(2) }}</div>
              <div>P/L: ${{ summary_medium.pnl|round(2) }}</div>
              <div>ROI: {% if summary_medium.roi is not none %}{{ (summary_medium.roi*100)|round(1) }}%{% else %}-{% endif %}</div>
            </div>
            <div class="summary-section">
              <h3>Low Confidence</h3>
              <div>Wins/Losses/Pushes: {{ summary_low.wins }}/{{ summary_low.losses }}/{{ summary_low.pushes }}</div>
              <div>Accuracy: {% if summary_low.accuracy is not none %}{{ (summary_low.accuracy*100)|round(1) }}%{% else %}-{% endif %}</div>
              <div>Total Stake: ${{ summary_low.stake|round(2) }}</div>
              <div>P/L: ${{ summary_low.pnl|round(2) }}</div>
              <div>ROI: {% if summary_low.roi is not none %}{{ (summary_low.roi*100)|round(1) }}%{% else %}-{% endif %}</div>
            </div>
          </div>

          {% macro table_for(rows) %}
          <table class="recs-table">
            <thead>
              <tr>
                <th>Conf</th>
                <th>Matchup</th>
                <th>Market</th>
                <th>Bet</th>
                <th>Price</th>
                <th>Model %</th>
                <th>EV</th>
                <th>Edge</th>
                <th>Book</th>
                <th>Stake</th>
                <th>Result</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td>
                  {% set c = r.confidence or '' %}
                  {% if c=='high' %}<span class="conf-badge conf-high">High</span>{% elif c=='medium' %}<span class="conf-badge conf-medium">Med</span>{% elif c=='low' %}<span class="conf-badge conf-low">Low</span>{% else %}<span class="conf-badge conf-other">—</span>{% endif %}
                </td>
                <td>{{ r.away }} @ {{ r.home }}</td>
                <td><span class="pill">{{ r.market|capitalize }}</span></td>
                <td>{{ r.bet }}</td>
                <td>{% if r.price is not none %}{{ r.price }}{% else %}-{% endif %}</td>
                <td>{% if r.model_prob is not none %}{{ (r.model_prob*100)|round(1) }}%{% else %}-{% endif %}</td>
                <td>{% if r.ev is not none %}{% set evp=(r.ev*100) %}{% if evp>0 %}+{% endif %}{{ evp|round(1) }}%{% else %}-{% endif %}</td>
                {% set edge_val = r.edge if r.edge is not none else r.edge_pts %}
                <td>{% if edge_val is not none %}{% if edge_val>0 %}+{% endif %}{{ edge_val|round(2) }}{% if r.market!='moneyline' and edge_val is not none %}g{% endif %}{% else %}-{% endif %}</td>
                <td>
                  {% if r.book %}<span class="book-badge">{{ r.book }}</span>{% else %}<span class="book-badge">DK</span>{% endif %}
                </td>
                <td>{% if r.stake is not none %}${{ r.stake|round(2) }}{% elif bankroll and bankroll>0 %}--{% else %}$100{% endif %}</td>
                <td>{% if r.result %}{{ r.result|capitalize }}{% else %}-{% endif %}</td>
                <td>{{ r.date or '' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endmacro %}

          {% if rows_high|length > 0 %}
            <h2>High Confidence</h2>
            {{ table_for(rows_high) }}
          {% endif %}

          {% if rows_medium|length > 0 %}
            <h2>Medium Confidence</h2>
            {{ table_for(rows_medium) }}
          {% endif %}

          {% if rows_low|length > 0 %}
            <h2>Low Confidence</h2>
            {{ table_for(rows_low) }}
          {% endif %}

          {% if rows_other|length > 0 %}
            <h2>Other</h2>
            {{ table_for(rows_other) }}
          {% endif %}

          <p class="meta">Note: Stake uses Kelly fraction when bankroll is provided; otherwise a flat $100 is assumed for display. Book badge defaults to DK when source unknown. Confidence tiers: High ≥ {{ (high_ev*100)|round(1) }}%, Medium ≥ {{ (med_ev*100)|round(1) }}%, Low ≥ 0%.</p>
        </div>
      <div class="meta">Sorted by EV by default. Use filters above to refine.</div>
    </div>
  </div>

  <script>
    (function(){
      const bankEl = document.querySelector('input[name="bankroll"]');
      const kellyEl = document.querySelector('input[name="kelly_fraction_part"]');
      const autoBox = document.getElementById('autoRefreshBox');
      const exportBtn = document.getElementById('exportCsv');
      // Persist bankroll & kelly
      try {
        if (bankEl) {
          const v = localStorage.getItem('rec_bankroll');
          if (v && !bankEl.value) bankEl.value = v;
          bankEl.addEventListener('change', ()=> localStorage.setItem('rec_bankroll', bankEl.value||''));
        }
        if (kellyEl) {
          const v2 = localStorage.getItem('rec_kelly');
          if (v2 && !kellyEl.value) kellyEl.value = v2;
          kellyEl.addEventListener('change', ()=> localStorage.setItem('rec_kelly', kellyEl.value||''));
        }
      } catch(e){}
      // Auto-refresh
      function applyAutoState(){
        try { autoBox.checked = localStorage.getItem('recs_auto')==='on'; } catch {}
      }
      applyAutoState();
      if (autoBox) {
        autoBox.addEventListener('change', ()=>{
          try { localStorage.setItem('recs_auto', autoBox.checked?'on':'off'); } catch {}
        });
      }
      setInterval(()=>{
        if (autoBox && autoBox.checked) {
          const url = new URL(window.location.href);
          window.location.href = url.toString();
        }
      }, 120000);
      // CSV export
      if (exportBtn) {
        exportBtn.addEventListener('click', async ()=>{
          try {
            const qs = window.location.search || '?';
            const apiUrl = '/api/recommendations'+qs;
            const r = await fetch(apiUrl, {cache:'no-store'});
            if (!r.ok) return alert('Failed to fetch recommendations JSON');
            const rows = await r.json();
            if (!Array.isArray(rows)) return alert('No data');
            const cols = ['date','away','home','market','bet','price','model_prob','ev','edge','edge_pts','book','stake','result','confidence'];
            const header = cols.join(',');
            const lines = [header];
            for (const row of rows) {
              const out = cols.map(c=>{
                let v = row[c];
                if (v === null || v === undefined) return '';
                if (typeof v === 'number') return String(v);
                const s = String(v).replace(/"/g,'""');
                if (s.search(/[",\n]/)>=0) return '"'+s+'"';
                return s;
              }).join(',');
              lines.push(out);
            }
            const blob = new Blob([lines.join('\n')], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'recommendations_'+(new Date().toISOString().slice(0,10))+'.csv';
            document.body.appendChild(a); a.click(); a.remove();
          } catch(e){ alert('Export failed'); }
        });
      }
    })();
  </script>
</body>
</html>
