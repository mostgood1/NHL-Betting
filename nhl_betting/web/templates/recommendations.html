<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHL Betting – Recommendations</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .page { padding: 18px 0; }
    .nav { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .nav a { color:#cfe0ff; text-decoration:none; background:#243056; border:1px solid #384a7a; padding:6px 8px; border-radius:6px; font-size:13px; }
    .filters { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin: 8px 0 12px; }
    .filters input, .filters select { background:#0f1530; color:#e8eaf6; border:1px solid #25316a; border-radius:6px; padding:6px 8px; }
    .summary-cards { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin: 10px 0 16px; }
    .sum-card { background:#0f1530; border:1px solid #25316a; border-radius:10px; padding:10px; color:#cfe0ff; font-size:14px; }
  .sum-card h3 { margin: 0 0 6px; font-size:14px; color:#dbe6ff; text-transform: uppercase; }
    h2 { margin: 16px 0 8px; font-size: 18px; color:#c9d3ff; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid #25316a; text-align:left; }
    .market-pill { display:inline-block; padding:2px 6px; border-radius:10px; background:#0f1530; border:1px solid #25316a; color:#d5dbff; font-size:12px; }
    /* Pick text stays white; keep tiered badge pills as-is */
    .pick-high, .pick-medium, .pick-low, .pick-other { font-weight:700; color:#ffffff; }
  .badge { display:inline-block; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:6px; border:1px solid transparent; }
  .badge-high { background:#063a2a; color:#a7f3c6; border-color:#0a5a40; }
  .badge-medium { background:#3a2e06; color:#ffeaa7; border-color:#6a530a; }
  .badge-low { background:#1e244a; color:#dfe6ff; border-color:#2a356b; }
  .badge-other { background:#222a3a; color:#b0bec5; border-color:#314155; }
  /* Result pills: green=win, red=loss, yellow=push */
  .result-pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid transparent; }
  .result-win { background:#063a2a; color:#a7f3c6; border-color:#0a5a40; }
  .result-loss { background:#3a0a0a; color:#fca5a5; border-color:#7a2e2e; }
  .result-push { background:#3a2e06; color:#ffeaa7; border-color:#6a530a; }
    .date-nav { display:flex; gap:8px; align-items:center; }
    .meta-note { color:#9fb0ff; font-size:12px; }
    /* Buttons/links */
    .link-reset { display:inline-block; margin-left:6px; text-decoration:none; }
    .btn-chip { display:inline-block; background:#243056; border:1px solid #384a7a; padding:6px 8px; border-radius:6px; font-size:13px; color:#cfe0ff; }
    .filters a { color:#9fb0ff; text-decoration: underline; }
  </style>
  </head>
<body>
  <div class="container page">
    <h1>NHL Betting – Recommendations</h1>
    <div class="nav">
      <a href="/">Cards</a>
      <a href="/recommendations">Recommendations</a>
      <a href="/props">Props</a>
      <a href="/reconciliation">Reconciliation</a>
      <a href="/api/predictions">API</a>
      <a href="/health">Health</a>
    </div>

    {# Money formatting helpers for summary cards #}
    {% macro money(val) -%}
      {% if val is none %}—{% else %}${{ ('%.0f' % (val)) }}{% endif %}
    {%- endmacro %}
    {% macro money_signed(val) -%}
      {% if val is none %}—{% else %}{% set v = val %}{% if v < 0 %}-${{ ('%.0f' % (-v)) }}{% else %}${{ ('%.0f' % v) }}{% endif %}{% endif %}
    {%- endmacro %}

    <div class="summary-cards">
      <div class="sum-card">
        <h3>Overall</h3>
        <div>{% if summary_overall.accuracy is not none %}{{ (summary_overall.accuracy*100)|round(1) }}%{% else %}—{% endif %} Accuracy</div>
        <div>{{ summary_overall.wins }}W-{{ summary_overall.losses }}L / {{ summary_overall.wins + summary_overall.losses }} settled</div>
        <div>ROI: {% if summary_overall.roi is not none %}{{ (summary_overall.roi*100)|round(1) }}%{% else %}—{% endif %}</div>
        <div>Stake: {{ money(summary_overall.stake) }} | P/L: {{ money_signed(summary_overall.pnl) }}</div>
        <div>Total picks: {{ total_picks }}</div>
      </div>
      <div class="sum-card">
        <h3>High</h3>
        <div>{% if summary_high.accuracy is not none %}{{ (summary_high.accuracy*100)|round(1) }}%{% else %}—{% endif %} Acc</div>
        <div>{{ summary_high.wins }}W-{{ summary_high.losses }}L / {{ summary_high.wins + summary_high.losses }}</div>
        <div>Stake: {{ money(summary_high.stake) }} | P/L: {{ money_signed(summary_high.pnl) }}</div>
        <div>ROI: {% if summary_high.roi is not none %}{{ (summary_high.roi*100)|round(1) }}%{% else %}—{% endif %}</div>
        <div>Picks: {{ rows_high|length }}</div>
      </div>
      <div class="sum-card">
        <h3>Medium</h3>
        <div>{% if summary_medium.accuracy is not none %}{{ (summary_medium.accuracy*100)|round(1) }}%{% else %}—{% endif %} Acc</div>
        <div>{{ summary_medium.wins }}W-{{ summary_medium.losses }}L / {{ summary_medium.wins + summary_medium.losses }}</div>
        <div>Stake: {{ money(summary_medium.stake) }} | P/L: {{ money_signed(summary_medium.pnl) }}</div>
        <div>ROI: {% if summary_medium.roi is not none %}{{ (summary_medium.roi*100)|round(1) }}%{% else %}—{% endif %}</div>
        <div>Picks: {{ rows_medium|length }}</div>
      </div>
      <div class="sum-card">
        <h3>Low</h3>
        <div>{% if summary_low.accuracy is not none %}{{ (summary_low.accuracy*100)|round(1) }}%{% else %}—{% endif %} Acc</div>
        <div>{{ summary_low.wins }}W-{{ summary_low.losses }}L / {{ summary_low.wins + summary_low.losses }}</div>
        <div>Stake: {{ money(summary_low.stake) }} | P/L: {{ money_signed(summary_low.pnl) }}</div>
        <div>ROI: {% if summary_low.roi is not none %}{{ (summary_low.roi*100)|round(1) }}%{% else %}—{% endif %}</div>
        <div>Picks: {{ rows_low|length }}</div>
      </div>
      
    </div>
  <div class="meta-note">Sorted by confidence then E.V. Odds assumed -110 for spread/total when book odds are not present.</div>

  {% if recon_summary %}
    <div class="summary-cards recon-block">
      <div class="sum-card">
        <h3>Reconciliation</h3>
        <div>Settled: {{ recon_summary.wins + recon_summary.losses }} ({{ recon_summary.wins }}W-{{ recon_summary.losses }}L{% if recon_summary.pushes %}-{{ recon_summary.pushes }}P{% endif %})</div>
        <div>ROI: {% if recon_summary.roi is not none %}{{ (recon_summary.roi*100)|round(1) }}%{% else %}—{% endif %}</div>
        <div>Stake: {% if recon_summary.stake is not none %}${{ ('%.0f' % recon_summary.stake) }}{% else %}—{% endif %} | P/L: {% if recon_summary.pnl is not none %}{% set _p = recon_summary.pnl %}{% if _p < 0 %}-${{ ('%.0f' % (-_p)) }}{% else %}${{ ('%.0f' % _p) }}{% endif %}{% else %}—{% endif %}</div>
      </div>
    </div>
  {% endif %}

    <form method="get" class="filters">
      <label>Date <input id="dateInput" type="date" name="date" value="{{ date or '' }}" /></label>
      <label>Sort by
        <select name="sort_by">
          <option value="ev" {% if sort_by=='ev' %}selected{% endif %}>Confidence (default)</option>
          <option value="edge" {% if sort_by=='edge' %}selected{% endif %}>Edge</option>
          <option value="prob" {% if sort_by=='prob' %}selected{% endif %}>Model %</option>
          <option value="price" {% if sort_by=='price' %}selected{% endif %}>Price</option>
          <option value="bet" {% if sort_by=='bet' %}selected{% endif %}>Bet type</option>
        </select>
      </label>
      <button type="submit">Apply</button>
      <a href="/recommendations?date={{ date }}">Reset</a>
    </form>

  {% macro rec_table(rows, tier) %}
    <table>
      <thead>
        <tr>
          <th>Game</th>
          <th>Type</th>
          <th>Selection</th>
          <th>Odds</th>
          <th>EV</th>
          <th>Result</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        {% set price = r.price if r.price is not none else (-110 if r.market!='moneyline' else -110) %}
        <tr>
          <td>{{ r.away }} @ {{ r.home }}</td>
          <td>{{ r.market|upper }}</td>
          {% if r.market == 'moneyline' %}
            {% set team = (r.home if r.bet=='home_ml' else r.away) %}
            <td class="pick-{{ tier }}">{{ team }} ML <span class="badge badge-{{ tier }}">{{ tier|capitalize }}</span></td>
          {% elif r.market == 'totals' %}
            {% set line = r.total_line_used %}
            <td class="pick-{{ tier }}">{{ r.bet|capitalize }}{% if line is not none %} {{ '%.1f' % line }}{% endif %} <span class="badge badge-{{ tier }}">{{ tier|capitalize }}</span></td>
          {% elif r.market == 'puckline' %}
            {% set team = (r.home if r.bet=='home_pl_-1.5' else r.away) %}
            {% set sign = ('-1.5' if r.bet=='home_pl_-1.5' else '+1.5') %}
            <td class="pick-{{ tier }}">{{ team }} {{ sign }} <span class="badge badge-{{ tier }}">{{ tier|capitalize }}</span></td>
          {% else %}
            <td class="pick-{{ tier }}">{{ r.bet|upper }} <span class="badge badge-{{ tier }}">{{ tier|capitalize }}</span></td>
          {% endif %}
          <td>{{ price }}</td>
          <td>{% if r.ev is not none %}{{ (r.ev*100)|round(1) }}%{% else %}—{% endif %}</td>
          <td>
            {% if r.result %}
              {% set rlow = r.result|lower %}
              <span class="result-pill result-{{ 'win' if rlow=='win' else ('loss' if rlow=='loss' else ('push' if rlow=='push' else 'other')) }}">{{ r.result|title }}</span>
            {% else %}
              —
            {% endif %}
          </td>
          <td>{% if r.date %}{{ r.date }}{% else %}{{ date }}{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endmacro %}

    {% if rows_high|length > 0 %}
      <h2>High confidence</h2>
      {{ rec_table(rows_high, 'high') }}
    {% endif %}

    {% if rows_medium|length > 0 %}
      <h2>Medium confidence</h2>
      {{ rec_table(rows_medium, 'medium') }}
    {% endif %}

    {% if rows_low|length > 0 %}
      <h2>Low confidence</h2>
      {{ rec_table(rows_low, 'low') }}
    {% endif %}

    

  <script>
    // Default the date input to today's date if empty
    (function(){
      const inp = document.getElementById('dateInput');
      if (inp && !inp.value) {
        const tzoffset = (new Date()).getTimezoneOffset() * 60000; // offset in ms
        const localISODate = (new Date(Date.now() - tzoffset)).toISOString().slice(0,10);
        inp.value = localISODate;
      }
    })();
  </script>

  </div>
  <footer>
    <div class="container">
      <div class="footer-note">
        <span>Last odds update: <strong><span id="luOdds">{{ last_updates.predictions_iso if last_updates and last_updates.predictions_iso else '' }}</span></strong></span>
        <span class="sep">|</span>
        <span>Last recommendations update: <strong><span id="luRecs">{{ last_updates.recommendations_iso if last_updates and last_updates.recommendations_iso else '' }}</span></strong></span>
      </div>
    </div>
  </footer>
</body>
<script>
(function(){
  function fmtLocal(iso){
    if(!iso) return '—';
    try{
      const d = new Date(iso);
      if (isNaN(d)) return '—';
      return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch(e){ return '—'; }
  }
  const o = document.getElementById('luOdds');
  const r = document.getElementById('luRecs');
  if (o) o.textContent = fmtLocal(o.textContent.trim());
  if (r) r.textContent = fmtLocal(r.textContent.trim());
})();
</script>
</html>
